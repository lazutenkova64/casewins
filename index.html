<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CaseWins - Открывай кейсы CS2</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Общие стили */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        :root {
            --primary-color: #ff4655;
            --primary-dark: #d93a48;
            --secondary-color: #1e2328;
            --accent-color: #0f1923;
            --light-color: #ece8e1;
            --dark-color: #111;
            --success-color: #4caf50;
            --gold-color: #ffd700;
            --blue-color: #4a90e2;
            --common-color: #5e98d9;
            --uncommon-color: #4b69ff;
            --rare-color: #8847ff;
            --mythical-color: #d32ee6;
            --legendary-color: #ffd700;
            --ancient-color: #eb4b4b;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --glass-bg: rgba(30, 35, 40, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--secondary-color) 100%);
            color: var(--light-color);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Шапка */
        header {
            background: linear-gradient(180deg, rgba(15, 25, 35, 0.95) 0%, rgba(15, 25, 35, 0.85) 100%);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 800;
            color: var(--light-color);
            text-transform: uppercase;
            cursor: pointer;
            transition: var(--transition);
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .logo i {
            color: var(--primary-color);
            font-size: 28px;
        }

        .logo span {
            color: var(--primary-color);
            background: linear-gradient(45deg, var(--primary-color), #ff6b7a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .user-online {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 14px;
            color: var(--light-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-online i {
            color: #4caf50;
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 30px;
        }

        nav a {
            color: var(--light-color);
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
            transition: var(--transition);
            padding: 8px 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        nav a:hover, nav a.active {
            background: linear-gradient(45deg, var(--primary-color), #ff6b7a);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 70, 85, 0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .balance {
            background: var(--glass-bg);
            padding: 10px 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(5px);
        }

        .balance i {
            color: var(--gold-color);
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--primary-color);
            cursor: pointer;
            transition: var(--transition);
            background: var(--glass-bg);
        }

        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 70, 85, 0.5);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Кнопка админ-панели */
        .admin-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(45deg, var(--primary-color), #ff6b7a);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: var(--transition);
            font-size: 18px;
            backdrop-filter: blur(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .admin-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 8px 20px rgba(255, 70, 85, 0.4);
        }

        .admin-btn.visible {
            display: flex;
        }

        .admin-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--primary-color);
            color: white;
            width: 18px;
            height: 18px;
         
        const registerConfirm = document.getElementById('register-confirm');
        
        const resultModal = document.getElementById('result-modal');
        const closeResultModalBtn = document.getElementById('close-result-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const sellItemBtn = document.getElementById('sell-item-btn');
        const openAgainBtn = document.getElementById('open-again-btn');
        const wonItemImg = document.getElementById('won-item-img');
        const wonItemName = document.getElementById('won-item-name');
        const wonItemPrice = document.getElementById('won-item-price');
        const wonItemRarity = document.getElementById('won-item-rarity');
        const resultMessage = document.getElementById('result-message');
        
        const contractResultModal = document.getElementById('contract-result-modal');
        const closeContractResultModal = document.getElementById('close-contract-result-modal');
        const sellContractItemBtn = document.getElementById('sell-contract-item-btn');
        const closeContractModalBtn = document.getElementById('close-contract-modal-btn');
        const contractWonItemImg = document.getElementById('contract-won-item-img');
        const contractWonItemName = document.getElementById('contract-won-item-name');
        const contractWonItemPrice = document.getElementById('contract-won-item-price');
        const contractWonItemRarity = document.getElementById('contract-won-item-rarity');
        
        const selectItemModal = document.getElementById('select-item-modal');
        const closeSelectModal = document.getElementById('close-select-modal');
        const selectInventoryGrid = document.getElementById('select-inventory-grid');
        
        const adminModal = document.getElementById('admin-modal');
        const closeAdminModalBtn = document.getElementById('close-admin-modal');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminContent = document.getElementById('admin-content');
        const adminUsersList = document.getElementById('admin-users-list');
        const userBalanceControl = document.getElementById('user-balance-control');
        const selectedUsername = document.getElementById('selected-username');
        const newBalance = document.getElementById('new-balance');
        const saveBalanceBtn = document.getElementById('save-balance-btn');
        const supportMessagesList = document.getElementById('support-messages-list');
        const supportMessagesCount = document.getElementById('support-messages-count');
        const adminReplyForm = document.getElementById('admin-reply-form');
        const adminReplyText = document.getElementById('admin-reply-text');
        const chatResolvedButtons = document.getElementById('chat-resolved-buttons');
        const markResolvedBtn = document.getElementById('mark-resolved-btn');
        const keepChatBtn = document.getElementById('keep-chat-btn');
        const adminReplyBtn = document.getElementById('admin-reply-btn');
        const adminSaveBtn = document.getElementById('admin-save-btn');
        const adminCancelBtn = document.getElementById('admin-cancel-btn');
        
        const dropsList = document.getElementById('drops-list');
        const footerHelp = document.getElementById('footer-help');

        // Инициализация
        function init() {
            if (currentUser) {
                const user = db.getUser(currentUser);
                if (user) {
                    updateUserDisplay();
                    profileTab.style.display = 'flex';
                    if (user.isAdmin) {
                        adminBtn.classList.add('visible');
                    }
                } else {
                    db.clearCurrentUser();
                    currentUser = null;
                }
            }
            
            loadRecentDrops();
            loadCases();
            updateAdminBadge();
            initEventListeners();
            updateOpenCaseButtons();
            
            setInterval(updateAdminBadge, 60000);
            
            // Инициализируем контрактные слоты (до 10)
            for (let i = 1; i <= 10; i++) {
                gameState.contractSlots[i] = null;
            }
            
            // Инициализация выбора количества кейсов
            initQuantitySelector();
        }

        // Инициализация обработчиков событий
        function initEventListeners() {
            logo.addEventListener('click', () => {
                showMainPage();
                setActiveTab(casesTab);
            });
            
            mainTab.addEventListener('click', (e) => {
                e.preventDefault();
                showMainPage();
                setActiveTab(mainTab);
            });
            
            casesTab.addEventListener('click', (e) => {
                e.preventDefault();
                showMainPage();
                setActiveTab(casesTab);
            });
            
            upgradeTab.addEventListener('click', (e) => {
                e.preventDefault();
                showUpgradeSection();
                setActiveTab(upgradeTab);
            });
            
            contractsTab.addEventListener('click', (e) => {
                e.preventDefault();
                showContractSection();
                setActiveTab(contractsTab);
            });
            
            profileTab.addEventListener('click', (e) => {
                e.preventDefault();
                showProfileSection();
                setActiveTab(profileTab);
            });
            
            userAvatarBtn.addEventListener('click', () => {
                if (currentUser) {
                    showProfileSection();
                    setActiveTab(profileTab);
                } else {
                    authModal.style.display = 'flex';
                }
            });
            
            closeOpeningBtn.addEventListener('click', () => {
                caseOpeningSection.classList.remove('active');
                caseSelection.style.display = 'block';
                resetCaseOpeningView();
                spinBtn.disabled = false;
                spinBtn.innerHTML = `<i class="fas fa-box-open"></i> Открыть кейс за <span id="spin-price">${casesData[gameState.selectedCase].price.toLocaleString()}</span>`;
            });
            
            spinBtn.addEventListener('click', startCaseOpening);
            
            supportFloatBtn.addEventListener('click', () => {
                supportChat.classList.toggle('active');
                supportNotification.style.display = 'none';
            });
            
            footerHelp.addEventListener('click', (e) => {
                e.preventDefault();
                supportChat.classList.toggle('active');
                supportNotification.style.display = 'none';
            });
            
            chatClose.addEventListener('click', () => {
                supportChat.classList.remove('active');
            });
            
            chatSend.addEventListener('click', sendSupportMessage);
            
            chatMessage.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    sendSupportMessage();
                }
            });
            
            // Профиль
            sellAllBtn.addEventListener('click', sellAllItems);
            prevPageBtn.addEventListener('click', () => {
                if (gameState.inventoryPage > 1) {
                    gameState.inventoryPage--;
                    loadInventoryPage();
                }
            });
            
            nextPageBtn.addEventListener('click', () => {
                const items = db.getInventory(currentUser);
                const totalPages = Math.ceil(items.length / gameState.itemsPerPage);
                if (gameState.inventoryPage < totalPages) {
                    gameState.inventoryPage++;
                    loadInventoryPage();
                }
            });
            
            activatePromocodeBtn.addEventListener('click', activatePromocode);
            promocodeInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    activatePromocode();
                }
            });
            
            // Апгрейд
            upgradeBalanceInput.addEventListener('input', updateUpgradeChance);
            upgradeStartBtn.addEventListener('click', startUpgrade);
            
            // Обработчики для выбора процента успеха
            document.querySelectorAll('.chance-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.chance-option').forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    gameState.upgradeSelectedChance = parseInt(this.dataset.chance);
                    updateUpgradeChance();
                    updateWheelVisual();
                    generatePossibleWin();
                });
            });
            
            // Контракты
            contractTradeupBtn.addEventListener('click', executeContract);
            
            // Модальное окно выбора предмета
            closeSelectModal.addEventListener('click', () => {
                selectItemModal.style.display = 'none';
            });
            
            // Админ панель
            adminBtn.addEventListener('click', () => {
                adminModal.style.display = 'flex';
                adminPasswordInput.value = '';
                adminContent.style.display = 'none';
            });
            
            closeAdminModalBtn.addEventListener('click', () => {
                adminModal.style.display = 'none';
            });
            
            adminLoginBtn.addEventListener('click', checkAdminPassword);
            adminPasswordInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    checkAdminPassword();
                }
            });
            
            adminReplyBtn.addEventListener('click', sendAdminReply);
            markResolvedBtn.addEventListener('click', markTicketResolved);
            keepChatBtn.addEventListener('click', keepChatOpen);
            adminSaveBtn.addEventListener('click', saveAdminSettings);
            adminCancelBtn.addEventListener('click', () => {
                adminModal.style.display = 'none';
            });
            
            saveBalanceBtn.addEventListener('click', saveUserBalance);
            
            // Модальное окно результата
            closeModalBtn.addEventListener('click', () => {
                resultModal.style.display = 'none';
                spinBtn.disabled = false;
                spinBtn.innerHTML = `<i class="fas fa-box-open"></i> Открыть кейс за <span id="spin-price">${casesData[gameState.selectedCase].price.toLocaleString()}</span>`;
            });
            
            closeResultModalBtn.addEventListener('click', () => {
                resultModal.style.display = 'none';
                spinBtn.disabled = false;
                spinBtn.innerHTML = `<i class="fas fa-box-open"></i> Открыть кейс за <span id="spin-price">${casesData[gameState.selectedCase].price.toLocaleString()}</span>`;
            });
            
            sellItemBtn.addEventListener('click', sellWonItem);
            
            openAgainBtn.addEventListener('click', () => {
                resultModal.style.display = 'none';
                if (gameState.selectedCase) {
                    openCaseView(gameState.selectedCase);
                }
                spinBtn.disabled = false;
                spinBtn.innerHTML = `<i class="fas fa-box-open"></i> Открыть кейс за <span id="spin-price">${casesData[gameState.selectedCase].price.toLocaleString()}</span>`;
            });
            
            // Контракт модальное окно
            closeContractResultModal.addEventListener('click', () => {
                contractResultModal.style.display = 'none';
            });
            
            sellContractItemBtn.addEventListener('click', sellContractItem);
            
            closeContractModalBtn.addEventListener('click', () => {
                contractResultModal.style.display = 'none';
            });
            
            // Авторизация
            loginTab.addEventListener('click', () => {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                loginError.style.display = 'none';
                registerError.style.display = 'none';
            });
            
            registerTab.addEventListener('click', () => {
                registerTab.classList.add('active');
                loginTab.classList.remove('active');
                registerForm.style.display = 'block';
                loginForm.style.display = 'none';
                loginError.style.display = 'none';
                registerError.style.display = 'none';
            });
            
            loginBtn.addEventListener('click', login);
            registerBtn.addEventListener('click', register);
            
            continueGuest.addEventListener('click', (e) => {
                e.preventDefault();
                authModal.style.display = 'none';
            });
            
            switchToLogin.addEventListener('click', (e) => {
                e.preventDefault();
                loginTab.click();
            });
            
            // Авторизация по нажатию Enter
            loginUsername.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') login();
            });
            
            loginPassword.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') login();
            });
            
            registerUsername.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') register();
            });
            
            registerPassword.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') register();
            });
            
            registerConfirm.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') register();
            });
        }

        // Инициализация выбора количества кейсов
        function initQuantitySelector() {
            document.querySelectorAll('.quantity-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.quantity-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    gameState.caseQuantity = parseInt(this.dataset.quantity);
                    updateSpinButtonPrice();
                });
            });
        }

        // Обновление цены на кнопке открытия кейса
        function updateSpinButtonPrice() {
            if (gameState.selectedCase) {
                const caseData = casesData[gameState.selectedCase];
                const totalPrice = caseData.price * gameState.caseQuantity;
                spinPriceSpan.textContent = totalPrice.toLocaleString();
            }
        }

        // Показать главную страницу
        function showMainPage() {
            caseOpeningSection.classList.remove('active');
            profileSection.style.display = 'none';
            upgradeSection.style.display = 'none';
            contractSection.style.display = 'none';
            caseSelection.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            resetCaseOpeningView();
        }

        // Показать секцию профиля
        function showProfileSection() {
            if (!currentUser) {
                authModal.style.display = 'flex';
                return;
            }
            
            caseOpeningSection.classList.remove('active');
            caseSelection.style.display = 'none';
            upgradeSection.style.display = 'none';
            contractSection.style.display = 'none';
            profileSection.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            resetCaseOpeningView();
            
            loadProfile();
            loadInventoryPage();
            resetPromocodeDisplay();
        }

        // Показать секцию апгрейда
        function showUpgradeSection() {
            if (!currentUser) {
                authModal.style.display = 'flex';
                return;
            }
            
            caseOpeningSection.classList.remove('active');
            caseSelection.style.display = 'none';
            profileSection.style.display = 'none';
            contractSection.style.display = 'none';
            upgradeSection.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            resetCaseOpeningView();
            
            resetUpgrade();
            loadUpgradeInventory();
        }

        // Показать секцию контрактов
        function showContractSection() {
            if (!currentUser) {
                authModal.style.display = 'flex';
                return;
            }
            
            caseOpeningSection.classList.remove('active');
            caseSelection.style.display = 'none';
            profileSection.style.display = 'none';
            upgradeSection.style.display = 'none';
            contractSection.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            resetCaseOpeningView();
            
            loadContractSlots();
            loadContractInventory();
            updateContractInfo();
        }

        // Установить активную вкладку
        function setActiveTab(tab) {
            document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
            tab.classList.add('active');
        }

        // Загрузка профиля
        function loadProfile() {
            if (!currentUser) return;
            
            const user = db.getUser(currentUser);
            if (!user) return;
            
            profileName.textContent = currentUser;
            profileRole.textContent = user.isAdmin ? 'Администратор' : 'Игрок';
            profileBalance.textContent = user.balance.toLocaleString();
            profileCasesOpened.textContent = user.casesOpened;
            profileTotalValue.textContent = user.totalValue.toLocaleString();
            profileBestItem.textContent = user.bestItem;
            
            updateAvatar(currentUser, profileAvatarLarge.querySelector('img'));
        }

        // Активация промокода
        function activatePromocode() {
            if (!currentUser) {
                authModal.style.display = 'flex';
                return;
            }
            
            const promocode = promocodeInput.value.trim().toLowerCase();
            const validPromocodes = ['андрей', 'максим'];
            
            promocodeSuccess.style.display = 'none';
            promocodeError.style.display = 'none';
            
            if (!promocode) {
                promocodeError.textContent = 'Введите промокод';
                promocodeError.style.display = 'block';
                return;
            }
            
            if (!validPromocodes.includes(promocode)) {
                promocodeError.textContent = 'Неверный промокод';
                promocodeError.style.display = 'block';
                return;
            }
            
            const user = db.getUser(currentUser);
            if (user.balance >= systemSettings.maxPromocodeBalance) {
                promocodeError.textContent = 'Больше промокод ввести временно не получится';
                promocodeError.style.display = 'block';
                return;
            }
            
            user.balance += systemSettings.promocodeValue;
            db.saveUser(currentUser, user);
            db.addUsedPromocode(currentUser, promocode);
            
            promocodeSuccess.textContent = `Промокод успешно активирован! +${systemSettings.promocodeValue} монет`;
            promocodeSuccess.style.display = 'block';
            promocodeInput.value = '';
            
            updateUserDisplay();
            loadProfile();
        }

        function resetPromocodeDisplay() {
            promocodeSuccess.style.display = 'none';
            promocodeError.style.display = 'none';
            promocodeInput.value = '';
        }

        // Загрузка страницы инвентаря
        function loadInventoryPage() {
            if (!currentUser) return;
            
            const items = db.getInventory(currentUser);
            const startIndex = (gameState.inventoryPage - 1) * gameState.itemsPerPage;
            const endIndex = startIndex + gameState.itemsPerPage;
            const pageItems = items.slice(startIndex, endIndex);
            
            inventoryGrid.innerHTML = '';
            
            if (pageItems.length === 0) {
                inventoryGrid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5); grid-column: 1 / -1;">
                        <i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <h3 style="margin-bottom: 10px;">Инвентарь пуст</h3>
                        <p>Откройте кейсы, чтобы получить предметы</p>
                    </div>
                `;
                sellAllBtn.disabled = true;
                return;
            }
            
            sellAllBtn.disabled = false;
            
            pageItems.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'inventory-item';
                itemElement.dataset.itemId = item.id;
                
                const rarityClass = `item-${item.rarity}`;
                
                // Разбиваем название на несколько строк
                const words = item.name.split(' ');
                let displayName = '';
                for (let i = 0; i < words.length; i++) {
                    displayName += words[i] + (i % 3 === 2 ? '\n' : ' ');
                }
                
                itemElement.innerHTML = `
                    <div class="item-img ${rarityClass}"></div>
                    <div class="item-name">${displayName}</div>
                    <div class="item-value">${item.value} <i class="fas fa-coins"></i></div>
                    <div class="item-actions">
                        <button class="item-btn contract-btn" data-action="contract" data-item-id="${item.id}">
                            Контракт
                        </button>
                        <button class="item-btn upgrade-btn-small" data-action="upgrade" data-item-id="${item.id}">
                            Апгрейд
                        </button>
                        <button class="item-btn sell-btn" data-action="sell" data-item-id="${item.id}">
                            Продать
                        </button>
                    </div>
                `;
                
                // Добавляем обработчик для кнопки "Контракт"
                const contractBtn = itemElement.querySelector('.contract-btn');
                contractBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showContractSection();
                    setActiveTab(contractsTab);
                });
                
                // Добавляем обработчик для кнопки "Апгрейд"
                const upgradeBtn = itemElement.querySelector('.upgrade-btn-small');
                upgradeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    setItemForUpgrade(item);
                    showUpgradeSection();
                    setActiveTab(upgradeTab);
                });
                
                // Добавляем обработчик для кнопки "Продать"
                const sellBtn = itemElement.querySelector('.sell-btn');
                sellBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    sellItem(item.id);
                });
                
                inventoryGrid.appendChild(itemElement);
            });
            
            // Обновляем пагинацию
            updatePagination(items.length);
        }

        // Обновление пагинации
        function updatePagination(totalItems) {
            const totalPages = Math.ceil(totalItems / gameState.itemsPerPage);
            
            pageNumbers.innerHTML = '';
            
            // Показываем только 5 страниц вокруг текущей
            let startPage = Math.max(1, gameState.inventoryPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('div');
                pageBtn.className = 'page-number';
                if (i === gameState.inventoryPage) {
                    pageBtn.classList.add('active');
                }
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    gameState.inventoryPage = i;
                    loadInventoryPage();
                });
                pageNumbers.appendChild(pageBtn);
            }
            
            prevPageBtn.disabled = gameState.inventoryPage === 1;
            nextPageBtn.disabled = gameState.inventoryPage === totalPages;
        }

        // Продажа всех предметов
        function sellAllItems() {
            if (!currentUser) return;
            
            const items = db.getInventory(currentUser);
            if (items.length === 0) return;
            
            const totalValue = items.reduce((sum, item) => sum + item.value, 0);
            
            if (confirm(`Продать все предметы (${items.length} шт.) за ${totalValue} монет?`)) {
                const user = db.getUser(currentUser);
                user.balance += totalValue;
                db.saveUser(currentUser, user);
                db.saveInventory(currentUser, []);
                updateUserDisplay();
                loadProfile();
                loadInventoryPage();
                alert(`Все предметы проданы за ${totalValue} монет!`);
            }
        }

        // Продажа одного предмета
        function sellItem(itemId) {
            if (!currentUser) return;
            
            const items = db.getInventory(currentUser);
            const item = items.find(i => i.id == itemId);
            if (!item) return;
            
            if (confirm(`Продать "${item.name}" за ${item.value} монет?`)) {
                const user = db.getUser(currentUser);
                user.balance += item.value;
                db.saveUser(currentUser, user);
                db.removeFromInventory(currentUser, itemId);
                updateUserDisplay();
                loadProfile();
                loadInventoryPage();
                
                // Обновляем апгрейд если продали выбранный предмет
                if (gameState.selectedUpgradeItem && gameState.selectedUpgradeItem.id == itemId) {
                    resetUpgrade();
                    loadUpgradeInventory();
                }
                
                // Обновляем контракты если продали предмет из слота
                for (let slot in gameState.contractSlots) {
                    if (gameState.contractSlots[slot] && gameState.contractSlots[slot].id == itemId) {
                        gameState.contractSlots[slot] = null;
                        loadContractSlots();
                        loadContractInventory();
                        updateContractInfo();
                    }
                }
            }
        }

        // Загрузка инвентаря для апгрейда
        function loadUpgradeInventory() {
            if (!currentUser) return;
            
            const items = db.getInventory(currentUser);
            upgradeInventoryGrid.innerHTML = '';
            
            if (items.length === 0) {
                upgradeInventoryGrid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5); grid-column: 1 / -1;">
                        <i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <h3 style="margin-bottom: 10px;">Инвентарь пуст</h3>
                        <p>Откройте кейсы, чтобы получить предметы</p>
                    </div>
                `;
                return;
            }
            
            items.forEach(item => {
                // Пропускаем если предмет уже выбран для апгрейда
                if (gameState.selectedUpgradeItem && gameState.selectedUpgradeItem.id === item.id) {
                    return;
                }
                
                const itemElement = document.createElement('div');
                itemElement.className = 'inventory-item';
                itemElement.dataset.itemId = item.id;
                
                const rarityClass = `item-${item.rarity}`;
                
                // Разбиваем название на несколько строк
                const words = item.name.split(' ');
                let displayName = '';
                for (let i = 0; i < words.length; i++) {
                    displayName += words[i] + (i % 3 === 2 ? '\n' : ' ');
                }
                
                itemElement.innerHTML = `
                    <div class="item-img ${rarityClass}"></div>
                    <div class="item-name">${displayName}</div>
                    <div class="item-value">${item.value} <i class="fas fa-coins"></i></div>
                `;
                
                itemElement.addEventListener('click', () => {
                    setItemForUpgrade(item);
                });
                
                upgradeInventoryGrid.appendChild(itemElement);
            });
        }

        // Установить предмет для апгрейда
        function setItemForUpgrade(item) {
            gameState.selectedUpgradeItem = item;
            gameState.upgradeResultItem = null;
            
            upgradeSelectedItem.classList.remove('empty');
            upgradeSelectedItem.innerHTML = `
                <div class="item-img item-${item.rarity}"></div>
                <div style="font-size: 16px; font-weight: 600; text-align: center; line-height: 1.3;">${item.name}</div>
                <div style="color: var(--gold-color); font-weight: 700;">${item.value} <i class="fas fa-coins"></i></div>
            `;
            
            upgradeResultItem.classList.add('empty');
            upgradeResultItem.innerHTML = `
                <i class="fas fa-gift" style="font-size: 48px; color: rgba(255,255,255,0.3); margin-bottom: 15px;"></i>
                <span style="color: rgba(255,255,255,0.5);">Здесь появится выигрыш</span>
            `;
            
            upgradeStartBtn.disabled = false;
            upgradeBalanceInput.value = '';
            gameState.upgradeBalanceAmount = 0;
            
            // Сбрасываем выбранный процент
            document.querySelectorAll('.chance-option').forEach(opt => opt.classList.remove('active'));
            gameState.upgradeSelectedChance = 0;
            
            updateUpgradeChance();
            updateWheelVisual();
            loadUpgradeInventory();
            
            // Генерируем возможный выигрыш
            generatePossibleWin();
        }

        // Генерация возможного выигрыша
        function generatePossibleWin() {
            if (!gameState.selectedUpgradeItem) return;
            
            const baseItem = gameState.selectedUpgradeItem;
            const chance = gameState.upgradeSelectedChance || 50;
            
            // Новая стоимость = исходная × (100 / процент)
            const newValue = Math.round(baseItem.value * (100 / chance));
            
            // Получаем следующую редкость
            const possibleItems = cs2Items[getNextRarity(baseItem.rarity)] || cs2Items.ancient;
            
            if (possibleItems && possibleItems.length > 0) {
                const randomItem = possibleItems[Math.floor(Math.random() * possibleItems.length)];
                gameState.upgradeResultItem = {
                    ...randomItem,
                    value: newValue
                };
                
                upgradeResultItem.classList.remove('empty');
                upgradeResultItem.innerHTML = `
                    <div class="item-img item-${randomItem.rarity}"></div>
                    <div style="font-size: 16px; font-weight: 600; text-align: center; line-height: 1.3;">${randomItem.name}</div>
                    <div style="color: var(--gold-color); font-weight: 700;">${newValue} <i class="fas fa-coins"></i></div>
                `;
            }
        }

        // Получить следующую редкость
        function getNextRarity(currentRarity) {
            const rarityOrder = ['common', 'uncommon', 'rare', 'mythical', 'legendary', 'ancient'];
            const currentIndex = rarityOrder.indexOf(currentRarity);
            return currentIndex < rarityOrder.length - 1 ? rarityOrder[currentIndex + 1] : 'ancient';
        }

        // Сброс апгрейда
        function resetUpgrade() {
            gameState.selectedUpgradeItem = null;
            gameState.upgradeSelectedChance = 0;
            gameState.upgradeBalanceAmount = 0;
            gameState.upgradeResultItem = null;
            
            upgradeSelectedItem.classList.add('empty');
            upgradeSelectedItem.innerHTML = `
                <i class="fas fa-plus" style="font-size: 48px; color: rgba(255,255,255,0.3); margin-bottom: 15px;"></i>
                <span style="color: rgba(255,255,255,0.5);">Выберите скин для апгрейда</span>
            `;
            
            upgradeResultItem.classList.add('empty');
            upgradeResultItem.innerHTML = `
                <i class="fas fa-gift" style="font-size: 48px; color: rgba(255,255,255,0.3); margin-bottom: 15px;"></i>
                <span style="color: rgba(255,255,255,0.5);">Здесь появится выигрыш</span>
            `;
            
            upgradeStatus.textContent = 'Выберите процент успеха';
            upgradeBalanceInput.value = '';
            upgradeStartBtn.disabled = true;
            
            document.querySelectorAll('.chance-option').forEach(opt => opt.classList.remove('active'));
            updateWheelVisual();
            
            loadUpgradeInventory();
        }

        // Обновление шанса апгрейда
        function updateUpgradeChance() {
            if (!gameState.selectedUpgradeItem) return;
            
            const balanceAmount = parseInt(upgradeBalanceInput.value) || 0;
            gameState.upgradeBalanceAmount = balanceAmount;
            
            if (gameState.upgradeSelectedChance === 0) {
                upgradeStatus.textContent = 'Выберите процент успеха';
                upgradeStartBtn.disabled = true;
                return;
            }
            
            const user = db.getUser(currentUser);
            if (balanceAmount > 0 && user.balance < balanceAmount) {
                upgradeStatus.textContent = 'Недостаточно средств';
                upgradeStartBtn.disabled = true;
                return;
            }
            
            const effectiveChance = gameState.upgradeSelectedChance + Math.floor(balanceAmount / 100);
            upgradeStatus.textContent = `Шанс успеха: ${Math.min(95, effectiveChance)}%`;
            upgradeStartBtn.disabled = false;
            
            // Обновляем возможный выигрыш
            generatePossibleWin();
        }

        // Обновление визуализации колеса
        function updateWheelVisual() {
            if (gameState.upgradeSelectedChance === 0) {
                wheelSuccessSector.style.setProperty('--success-degrees', '0deg');
            } else {
                const successDegrees = (gameState.upgradeSelectedChance / 100) * 360;
                wheelSuccessSector.style.setProperty('--success-degrees', `${successDegrees}deg`);
            }
        }

        // Запуск апгрейда
        function startUpgrade() {
            if (!currentUser || !gameState.selectedUpgradeItem || !gameState.upgradeResultItem || gameState.isWheelSpinning) return;
            
            const user = db.getUser(currentUser);
            const balanceAmount = gameState.upgradeBalanceAmount;
            
            if (balanceAmount > 0 && user.balance < balanceAmount) {
                alert('Недостаточно средств!');
                return;
            }
            
            // Анимация
            gameState.isWheelSpinning = true;
            upgradeStartBtn.disabled = true;
            upgradeStartBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Крутим...`;
            
            const spinDuration = Math.random() * 10000 + 5000; // 5-15 секунд
            const spinCount = Math.floor(Math.random() * 3) + 2; // 2-4 круга
            
            let startTime = null;
            let rotation = 0;
            
            const animateSpin = (timestamp) => {
                if (!startTime) startTime = timestamp;
                const progress = timestamp - startTime;
                
                if (progress < spinDuration) {
                    // Плавное вращение стрелки
                    const t = progress / spinDuration;
                    const easeOut = 1 - Math.pow(1 - t, 3);
                    rotation = easeOut * 360 * spinCount;
                    
                    wheelArrowNew.style.transform = `translateX(-50%) rotate(${rotation}deg)`;
                    requestAnimationFrame(animateSpin);
                } else {
                    // Завершение анимации
                    const finalRotation = rotation % 360;
                    const isSuccess = finalRotation < (gameState.upgradeSelectedChance / 100) * 360;
                    
                    // Если неудача, стрелка должна немного недокрутиться в 40% случаев
                    let finalAngle = finalRotation;
                    if (!isSuccess && Math.random() < 0.4) {
                        finalAngle = finalRotation - 5 - Math.random() * 15;
                    }
                    
                    wheelArrowNew.style.transform = `translateX(-50%) rotate(${finalAngle}deg)`;
                    
                    // Задержка перед показом результата
                    setTimeout(() => {
                        processUpgradeResult(isSuccess);
                        gameState.isWheelSpinning = false;
                        upgradeStartBtn.disabled = false;
                        upgradeStartBtn.innerHTML = `<i class="fas fa-play"></i> Начать апгрейд`;
                    }, 1000);
                }
            };
            
            requestAnimationFrame(animateSpin);
        }

        // Обработка результата апгрейда
        function processUpgradeResult(isSuccess) {
            const user = db.getUser(currentUser);
            const item = gameState.selectedUpgradeItem;
            const balanceAmount = gameState.upgradeBalanceAmount;
            
            // Списываем деньги
            if (balanceAmount > 0) {
                user.balance -= balanceAmount;
            }
            
            if (isSuccess) {
                // Успешный апгрейд
                db.removeFromInventory(currentUser, item.id);
                db.addToInventory(currentUser, gameState.upgradeResultItem);
                
                user.totalValue += gameState.upgradeResultItem.value;
                if (gameState.upgradeResultItem.value > getItemValue(user.bestItem)) {
                    user.bestItem = gameState.upgradeResultItem.name;
                }
                
                alert(`Апгрейд успешен! Вы получили: ${gameState.upgradeResultItem.name}`);
            } else {
                // Неудачный апгрейд
                db.removeFromInventory(currentUser, item.id);
                
                // Возвращаем 1% от стоимости предмета
                const refund = Math.floor(item.value * 0.01);
                user.balance += refund;
                
                alert(`Апгрейд провален! Вы получили ${refund} монет компенсации.`);
            }
            
            db.saveUser(currentUser, user);
            updateUserDisplay();
            loadProfile();
            loadInventoryPage();
            resetUpgrade();
        }

        // Загрузка слотов контракта
        function loadContractSlots() {
            contractSlotsGrid.innerHTML = '';
            
            for (let i = 1; i <= 10; i++) {
                const item = gameState.contractSlots[i];
                const slotElement = document.createElement('div');
                slotElement.className = 'contract-slot';
                slotElement.dataset.slot = i;
                
                if (item) {
                    slotElement.classList.add('with-item');
                    
                    const rarityClass = `item-${item.rarity}`;
                    
                    // Разбиваем название на несколько строк
                    const words = item.name.split(' ');
                    let displayName = '';
                    for (let i = 0; i < words.length; i++) {
                        displayName += words[i] + (i % 3 === 2 ? '\n' : ' ');
                    }
                    
                    slotElement.innerHTML = `
                        <div class="item-img ${rarityClass} contract-slot-item"></div>
                        <div class="contract-slot-name">${displayName}</div>
                        <div class="contract-slot-value">${item.value} <i class="fas fa-coins"></i></div>
                        <button class="remove-slot-btn" data-slot="${i}">&times;</button>
                    `;
                } else {
                    slotElement.innerHTML = `
                        <i class="fas fa-plus"></i>
                        <span>Добавить предмет</span>
                    `;
                }
                
                slotElement.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('remove-slot-btn')) {
                        selectItemForContractSlot(i);
                    }
                });
                
                contractSlotsGrid.appendChild(slotElement);
            }
            
            // Добавляем обработчики для кнопок удаления
            document.querySelectorAll('.remove-slot-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const slot = parseInt(btn.dataset.slot);
                    removeItemFromContractSlot(slot);
                });
            });
        }

        // Загрузка инвентаря для контракта
        function loadContractInventory() {
            if (!currentUser) return;
            
            const items = db.getInventory(currentUser);
            contractInventoryGrid.innerHTML = '';
            
            if (items.length === 0) {
                contractInventoryGrid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5); grid-column: 1 / -1;">
                        <i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <h3 style="margin-bottom: 10px;">Инвентарь пуст</h3>
                        <p>Откройте кейсы, чтобы получить предметы</p>
                    </div>
                `;
                return;
            }
            
            items.forEach(item => {
                // Пропускаем если предмет уже в слоте
                const isInSlot = Object.values(gameState.contractSlots).some(slotItem => 
                    slotItem && slotItem.id === item.id
                );
                if (isInSlot) return;
                
                const itemElement = document.createElement('div');
                itemElement.className = 'inventory-item';
                itemElement.dataset.itemId = item.id;
                
                const rarityClass = `item-${item.rarity}`;
                
                // Разбиваем название на несколько строк
                const words = item.name.split(' ');
                let displayName = '';
                for (let i = 0; i < words.length; i++) {
                    displayName += words[i] + (i % 3 === 2 ? '\n' : ' ');
                }
                
                itemElement.innerHTML = `
                    <div class="item-img ${rarityClass}"></div>
                    <div class="item-name">${displayName}</div>
                    <div class="item-value">${item.value} <i class="fas fa-coins"></i></div>
                `;
                
                itemElement.addEventListener('click', () => {
                    // Находим первый свободный слот
                    let freeSlot = null;
                    for (let i = 1; i <= 10; i++) {
                        if (!gameState.contractSlots[i]) {
                            freeSlot = i;
                            break;
                        }
                    }
                    
                    if (freeSlot) {
                        gameState.contractSlots[freeSlot] = item;
                        loadContractSlots();
                        loadContractInventory();
                        updateContractInfo();
                    } else {
                        alert('Все слоты заполнены! Максимум 10 предметов.');
                    }
                });
                
                contractInventoryGrid.appendChild(itemElement);
            });
        }

        // Выбор предмета для слота контракта
        function selectItemForContractSlot(slot) {
            if (!currentUser) return;
            
            const items = db.getInventory(currentUser);
            selectInventoryGrid.innerHTML = '';
            
            if (items.length === 0) {
                selectInventoryGrid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5); grid-column: 1 / -1;">
                        <i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <h3 style="margin-bottom: 10px;">Инвентарь пуст</h3>
                        <p>Откройте кейсы, чтобы получить предметы</p>
                    </div>
                `;
            } else {
                items.forEach(item => {
                    // Пропускаем если предмет уже в слоте
                    const isInSlot = Object.values(gameState.contractSlots).some(slotItem => 
                        slotItem && slotItem.id === item.id
                    );
                    if (isInSlot) return;
                    
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.dataset.itemId = item.id;
                    
                    const rarityClass = `item-${item.rarity}`;
                    
                    // Разбиваем название на несколько строк
                    const words = item.name.split(' ');
                    let displayName = '';
                    for (let i = 0; i < words.length; i++) {
                        displayName += words[i] + (i % 3 === 2 ? '\n' : ' ');
                    }
                    
                    itemElement.innerHTML = `
                        <div class="item-img ${rarityClass}"></div>
                        <div class="item-name">${displayName}</div>
                        <div class="item-value">${item.value} <i class="fas fa-coins"></i></div>
                    `;
                    
                    itemElement.addEventListener('click', () => {
                        gameState.contractSlots[slot] = item;
                        loadContractSlots();
                        loadContractInventory();
                        updateContractInfo();
                        selectItemModal.style.display = 'none';
                    });
                    
                    selectInventoryGrid.appendChild(itemElement);
                });
            }
            
            selectItemModal.style.display = 'flex';
        }

        // Удаление предмета из слота контракта
        function removeItemFromContractSlot(slot) {
            gameState.contractSlots[slot] = null;
            loadContractSlots();
            loadContractInventory();
            updateContractInfo();
        }

        // Обновление информации о контракте
        function updateContractInfo() {
            const items = Object.values(gameState.contractSlots).filter(item => item !== null);
            const itemsCount = items.length;
            const totalValue = items.reduce((sum, item) => sum + item.value, 0);
            
            gameState.contractItemsCount = itemsCount;
            gameState.contractTotalValue = totalValue;
            
            contractItemsCount.textContent = itemsCount;
            contractTotalValue.textContent = totalValue;
            
            if (itemsCount >= 3) {
                const minWin = Math.floor(totalValue / 4);
                const maxWin = totalValue * 4;
                contractPossibleWin.textContent = `${minWin} - ${maxWin}`;
                
                contractTradeupBtn.disabled = false;
            } else {
                contractPossibleWin.textContent = '0 - 0';
                contractTradeupBtn.disabled = true;
            }
        }

        // Выполнение контракта
        function executeContract() {
            if (!currentUser || gameState.contractItemsCount < 3) return;
            
            const items = Object.values(gameState.contractSlots).filter(item => item !== null);
            const totalValue = gameState.contractTotalValue;
            
            // Анимация
            contractTradeupBtn.disabled = true;
            contractTradeupBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Создание...`;
            
            setTimeout(() => {
                // Удаляем предметы из инвентаря
                items.forEach(item => {
                    db.removeFromInventory(currentUser, item.id);
                });
                
                // Всегда успешный контракт
                const minWin = Math.floor(totalValue / 4);
                const maxWin = totalValue * 4;
                const winValue = Math.floor(Math.random() * (maxWin - minWin + 1)) + minWin;
                
                // Создаем случайный предмет с соответствующей стоимостью
                const allItems = [
                    ...cs2Items.common,
                    ...cs2Items.uncommon,
                    ...cs2Items.rare,
                    ...cs2Items.mythical,
                    ...cs2Items.legendary,
                    ...cs2Items.ancient
                ];
                
                let winItem = allItems[Math.floor(Math.random() * allItems.length)];
                winItem = { ...winItem, value: winValue };
                
                // Добавляем новый предмет
                db.addToInventory(currentUser, winItem);
                
                const user = db.getUser(currentUser);
                user.totalValue += winValue;
                if (winValue > getItemValue(user.bestItem)) {
                    user.bestItem = winItem.name;
                }
                db.saveUser(currentUser, user);
                
                // Сохраняем результат контракта
                gameState.contractResult = winItem;
                
                // Показываем результат
                showContractResultModal(winItem);
                
                // Очищаем слоты
                for (let i = 1; i <= 10; i++) {
                    gameState.contractSlots[i] = null;
                }
                
                updateUserDisplay();
                loadProfile();
                loadInventoryPage();
                loadContractSlots();
                loadContractInventory();
                updateContractInfo();
                
                contractTradeupBtn.disabled = false;
                contractTradeupBtn.innerHTML = `<i class="fas fa-exchange-alt"></i> Создать контракт`;
            }, 2000);
        }

        // Показать результат контракта
        function showContractResultModal(item) {
            contractWonItemImg.className = `item-img item-${item.rarity}`;
            contractWonItemName.textContent = item.name;
            contractWonItemPrice.innerHTML = `Цена: ${item.value} <i class="fas fa-coins"></i>`;
            contractWonItemRarity.textContent = getRarityName(item.rarity);
            contractWonItemRarity.className = 'item-rarity';
            contractWonItemRarity.classList.add(`rarity-${item.rarity}`);
            
            contractResultModal.style.display = 'flex';
        }

        // Продать предмет из контракта
        function sellContractItem() {
            if (!currentUser || !gameState.contractResult) return;
            
            const user = db.getUser(currentUser);
            const item = gameState.contractResult;
            
            user.balance += item.value;
            db.saveUser(currentUser, user);
            updateUserDisplay();
            contractResultModal.style.display = 'none';
            
            alert(`Предмет "${item.name}" продан за ${item.value} монет!`);
            gameState.contractResult = null;
        }

        // Обработка открытия кейса
        function startCaseOpening() {
            if (!currentUser) {
                authModal.style.display = 'flex';
                return;
            }
            
            const caseId = gameState.selectedCase;
            const caseData = casesData[caseId];
            const user = db.getUser(currentUser);
            const totalPrice = caseData.price * gameState.caseQuantity;
            
            if (user.balance < totalPrice) {
                alert('Недостаточно средств для открытия кейсов!');
                return;
            }
            
            // Показываем ленту с предметами
            caseOpeningStart.style.display = 'none';
            centerLine.style.display = 'block';
            maskLeft.style.display = 'block';
            maskRight.style.display = 'block';
            caseItemsScroll.style.display = 'flex';
            
            // Инициализируем ленту
            initCaseScroll(caseData);
            
            // Начинаем анимацию
            spinCase();
        }

        // Сброс вида открытия кейса
        function resetCaseOpeningView() {
            caseOpeningStart.style.display = 'flex';
            centerLine.style.display = 'none';
            maskLeft.style.display = 'none';
            maskRight.style.display = 'none';
            caseItemsScroll.style.display = 'none';
            
            stopItemAnimation();
            if (gameState.animationInterval) {
                clearInterval(gameState.animationInterval);
                gameState.animationInterval = null;
            }
        }

        // Инициализация ленты с предметами
        function initCaseScroll(caseData) {
            caseItemsScroll.innerHTML = '';
            gameState.currentScrollItems = [];
            
            for (let i = 0; i < 30; i++) {
                addRandomItemToScroll(caseData);
            }
        }

        // Добавление случайного предмета в ленту
        function addRandomItemToScroll(caseData) {
            const items = caseData.items;
            const randomItem = items[Math.floor(Math.random() * items.length)];
            
            const itemElement = document.createElement('div');
            itemElement.className = 'scroll-item';
            
            const rarity = randomItem.rarity;
            const rarityColor = getRarityColor(rarity);
            
            itemElement.style.borderColor = rarityColor;
            
            itemElement.innerHTML = `
                <div class="item-img item-${rarity}"></div>
                <div class="scroll-item-name">${randomItem.name}</div>
                <div class="scroll-item-price">${randomItem.value} <i class="fas fa-coins"></i></div>
            `;
            
            itemElement.classList.add(`rarity-${rarity}`);
            itemElement.dataset.item = JSON.stringify(randomItem);
            
            caseItemsScroll.appendChild(itemElement);
            gameState.currentScrollItems.push(itemElement);
            
            return itemElement;
        }

        // Запуск анимации прокрутки кейса
        function spinCase() {
            if (gameState.isSpinning) return;
            
            const caseId = gameState.selectedCase;
            const caseData = casesData[caseId];
            const user = db.getUser(currentUser);
            const totalPrice = caseData.price * gameState.caseQuantity;
            
            user.balance -= totalPrice;
            user.casesOpened += gameState.caseQuantity;
            
            gameState.isSpinning = true;
            gameState.currentCaseOpening = 0;
            gameState.caseResults = [];
            
            spinBtn.disabled = true;
            spinBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Открываем...`;
            
            // Генерируем результаты для всех кейсов
            for (let i = 0; i < gameState.caseQuantity; i++) {
                const randomItem = getRandomItem(caseData);
                gameState.caseResults.push(randomItem);
            }
            
            // Начинаем открывать кейсы по одному
            openNextCase();
        }

        // Открыть следующий кейс
        function openNextCase() {
            if (gameState.currentCaseOpening >= gameState.caseQuantity) {
                // Все кейсы открыты
                gameState.isSpinning = false;
                spinBtn.disabled = false;
                spinBtn.innerHTML = `<i class="fas fa-box-open"></i> Открыть кейс за <span id="spin-price">${casesData[gameState.selectedCase].price.toLocaleString()}</span>`;
                return;
            }
            
            const randomItem = gameState.caseResults[gameState.currentCaseOpening];
            gameState.spinResult = randomItem;
            
            // Начинаем анимацию прокрутки
            startItemAnimation(() => {
                // Анимация завершена, показываем результат
                const user = db.getUser(currentUser);
                db.addToInventory(currentUser, randomItem);
                user.totalValue += randomItem.value;
                if (user.bestItem === "Нет" || randomItem.value > getItemValue(user.bestItem)) {
                    user.bestItem = randomItem.name;
                }
                
                db.saveUser(currentUser, user);
                
                const drop = {
                    user: currentUser,
                    item: randomItem,
                    time: "Только что",
                    timestamp: Date.now()
                };
                
                db.addRecentDrop(drop);
                addDropToSidebar(drop);
                
                // Обновляем счетчик открытых кейсов
                gameState.currentCaseOpening++;
                
                // Показываем результат
                if (gameState.caseQuantity === 1) {
                    showResultModal(randomItem, randomItem.rarity);
                } else {
                    showBatchResultModal(randomItem, randomItem.rarity, gameState.currentCaseOpening);
                }
                
                updateUserDisplay();
            });
        }

        // Запуск анимации предметов
        function startItemAnimation(onComplete) {
            let scrollPosition = 0;
            let speed = 50;
            let deceleration = 0.97;
            let targetItemIndex = 15; // Индекс предмета, который должен оказаться по центру
            
            // Случайная длительность анимации 5-10 секунд
            const spinDuration = Math.random() * 5000 + 5000;
            
            const animate = () => {
                speed *= deceleration;
                scrollPosition += speed;
                
                caseItemsScroll.style.transform = `translateX(-${scrollPosition}px)`;
                
                if (speed < 0.5) {
                    // Анимация завершена, находим предмет под полоской
                    const scrollItems = document.querySelectorAll('.scroll-item');
                    let centerItem = null;
                    let minDistance = Infinity;
                    
                    scrollItems.forEach((item, index) => {
                        const rect = item.getBoundingClientRect();
                        const containerRect = caseOpeningContainer.getBoundingClientRect();
                        const itemCenter = rect.left + rect.width / 2;
                        const containerCenter = containerRect.left + containerRect.width / 2;
                        const distance = Math.abs(itemCenter - containerCenter);
                        
                        if (distance < minDistance) {
                            minDistance = distance;
                            centerItem = item;
                        }
                    });
                    
                    // Подсвечиваем выпавший предмет на 2 секунды
                    if (centerItem) {
                        centerItem.classList.add('active');
                        
                        setTimeout(() => {
                            centerItem.classList.remove('active');
                            if (onComplete) onComplete();
                        }, 2000);
                    } else {
                        if (onComplete) onComplete();
                    }
                    return;
                }
                
                requestAnimationFrame(animate);
            };
            
            animate();
        }

        // Остановка анимации предметов
        function stopItemAnimation() {
            if (gameState.animationInterval) {
                clearInterval(gameState.animationInterval);
                gameState.animationInterval = null;
            }
        }

        function getRandomItem(caseData) {
            const items = caseData.items;
            return items[Math.floor(Math.random() * items.length)];
        }

        function showResultModal(item, rarity) {
            wonItemImg.className = `item-img item-${rarity}`;
            wonItemName.textContent = item.name;
            wonItemPrice.innerHTML = `Цена: ${item.value} <i class="fas fa-coins"></i>`;
            wonItemRarity.textContent = getRarityName(rarity);
            wonItemRarity.className = 'item-rarity';
            wonItemRarity.classList.add(`rarity-${rarity}`);
            resultMessage.textContent = `Вы открыли кейс и получаете:`;
            
            resultModal.style.display = 'flex';
        }

        function showBatchResultModal(item, rarity, caseNumber) {
            wonItemImg.className = `item-img item-${rarity}`;
            wonItemName.textContent = item.name;
            wonItemPrice.innerHTML = `Цена: ${item.value} <i class="fas fa-coins"></i>`;
            wonItemRarity.textContent = getRarityName(rarity);
            wonItemRarity.className = 'item-rarity';
            wonItemRarity.classList.add(`rarity-${rarity}`);
            resultMessage.textContent = `Вы открыли кейс ${caseNumber}/${gameState.caseQuantity} и получаете:`;
            
            resultModal.style.display = 'flex';
        }

        function sellWonItem() {
            if (!currentUser || !gameState.spinResult) return;
            
            const user = db.getUser(currentUser);
            const item = gameState.spinResult;
            
            user.balance += item.value;
            db.saveUser(currentUser, user);
            updateUserDisplay();
            resultModal.style.display = 'none';
            
            alert(`Предмет "${item.name}" продан за ${item.value} монет!`);
            
            // Открываем следующий кейс если есть
            if (gameState.currentCaseOpening < gameState.caseQuantity) {
                setTimeout(() => {
                    openNextCase();
                }, 500);
            } else {
                spinBtn.disabled = false;
                spinBtn.innerHTML = `<i class="fas fa-box-open"></i> Открыть кейс за <span id="spin-price">${casesData[gameState.selectedCase].price.toLocaleString()}</span>`;
            }
        }

        function loadRecentDrops() {
            dropsList.innerHTML = '';
            
            const drops = db.getRecentDrops();
            
            if (drops.length === 0) {
                const usernames = ['ProPlayer', 'LuckyGuy', 'CS2Fan', 'Trader', 'Newbie', 'Veteran', 'Gambler'];
                const items = [
                    ...cs2Items.common.slice(0, 2),
                    ...cs2Items.uncommon.slice(0, 2),
                    ...cs2Items.rare.slice(0, 1),
                    ...cs2Items.mythical.slice(0, 1),
                    ...cs2Items.legendary.slice(0, 1)
                ];
                
                const times = ['2 мин назад', '5 мин назад', '10 мин назад', '15 мин назад', '20 мин назад'];
                
                for (let i = 0; i < 5; i++) {
                    const drop = {
                        user: usernames[i % usernames.length],
                        item: items[i % items.length],
                        time: times[i],
                        timestamp: Date.now() - (i * 300000)
                    };
                    
                    db.addRecentDrop(drop);
                    addDropToSidebar(drop);
                }
            } else {
                drops.forEach(drop => addDropToSidebar(drop));
            }
        }

        function addDropToSidebar(drop) {
            const dropItem = document.createElement('div');
            dropItem.className = 'drop-item';
            
            const rarity = drop.item.rarity;
            const rarityColor = getRarityColor(rarity);
            
            dropItem.style.borderLeftColor = rarityColor;
            
            const avatarColor = getAvatarColor(drop.user);
            const canvas = document.createElement('canvas');
            canvas.width = 45;
            canvas.height = 45;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = avatarColor;
            ctx.fillRect(0, 0, 45, 45);
            
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            const initials = drop.user.substring(0, 2).toUpperCase();
            ctx.fillText(initials, 22.5, 22.5);
            
            const avatarUrl = canvas.toDataURL();
            
            // Разбиваем название на несколько строк
            const words = drop.item.name.split(' ');
            let displayName = '';
            for (let i = 0; i < words.length; i++) {
                displayName += words[i] + (i % 2 === 1 ? '\n' : ' ');
            }
            
            dropItem.innerHTML = `
                <div class="drop-avatar">
                    <img src="${avatarUrl}" alt="${drop.user}">
                </div>
                <div class="drop-info">
                    <div class="drop-user">
                        <span>${drop.user}</span>
                        <span>${drop.time}</span>
                    </div>
                    <div class="drop-item-name" style="color: ${rarityColor}">${displayName}</div>
                    <div class="drop-value">${drop.item.value} <i class="fas fa-coins"></i></div>
                </div>
            `;
            
            dropsList.insertBefore(dropItem, dropsList.firstChild);
            
            const drops = dropsList.querySelectorAll('.drop-item');
            if (drops.length > 10) {
                drops[drops.length - 1].remove();
            }
        }

        function sendSupportMessage() {
            if (!currentUser) {
                alert('Пожалуйста, войдите в аккаунт чтобы отправить сообщение в поддержку');
                authModal.style.display = 'flex';
                return;
            }
            
            const message = chatMessage.value.trim();
            
            if (!message) {
                alert('Введите ваш вопрос');
                return;
            }
            
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message user';
            messageElement.innerHTML = `<strong>${currentUser}:</strong> ${message}`;
            chatBody.appendChild(messageElement);
            
            const ticket = {
                id: Date.now(),
                username: currentUser,
                message: message,
                time: new Date().toLocaleTimeString(),
                date: new Date().toLocaleDateString(),
                status: 'open',
                replies: []
            };
            
            db.addSupportTicket(ticket);
            db.addAdminMessage({
                ticketId: ticket.id,
                username: currentUser,
                message: message,
                time: ticket.time,
                isNew: true
            });
            
            updateAdminBadge();
            supportNotification.style.display = 'flex';
            chatMessage.value = '';
            
            setTimeout(() => {
                const responses = [
                    "Спасибо за ваше сообщение! Мы рассмотрим ваш вопрос в ближайшее время.",
                    "Ваш вопрос принят в обработку. Ожидайте ответа в течение 24 часов.",
                    "Мы получили ваше сообщение. Наши специалисты уже работают над решением вашей проблемы.",
                    "Благодарим за обращение! Мы свяжемся с вами в ближайшее время."
                ];
                
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                
                const responseElement = document.createElement('div');
                responseElement.className = 'chat-message support';
                responseElement.innerHTML = `<strong>Поддержка:</strong> ${randomResponse}`;
                chatBody.appendChild(responseElement);
                
                chatBody.scrollTop = chatBody.scrollHeight;
            }, 1000);
            
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function updateAdminBadge() {
            if (!currentUser) return;
            
            const user = db.getUser(currentUser);
            if (!user || !user.isAdmin) return;
            
            const adminMessages = db.getAdminMessages();
            const newMessages = adminMessages.filter(msg => msg.isNew);
            
            if (newMessages.length > 0) {
                adminBadge.textContent = newMessages.length > 9 ? '9+' : newMessages.length;
                adminBadge.style.display = 'flex';
            } else {
                adminBadge.style.display = 'none';
            }
        }

        function checkAdminPassword() {
            if (adminPasswordInput.value === systemSettings.adminPassword) {
                adminContent.style.display = 'block';
                loadAdminUsers();
                loadSupportMessages();
            } else {
                alert('Неверный пароль!');
            }
        }

        function loadAdminUsers() {
            const users = db.getUsers();
            adminUsersList.innerHTML = '';
            
            Object.keys(users).forEach(username => {
                const user = users[username];
                const userElement = document.createElement('div');
                userElement.className = 'admin-user-item';
                
                userElement.innerHTML = `
                    <div>
                        <strong>${username}</strong>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.7);">
                            Баланс: ${user.balance} | Кейсов: ${user.casesOpened}
                        </div>
                    </div>
                    <button class="admin-btn-submit edit-balance-btn" data-username="${username}" style="padding: 8px 15px;">
                        <i class="fas fa-edit"></i> Изменить баланс
                    </button>
                `;
                
                adminUsersList.appendChild(userElement);
            });
            
            document.querySelectorAll('.edit-balance-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const username = btn.dataset.username;
                    selectedUsername.textContent = username;
                    newBalance.value = users[username].balance;
                    userBalanceControl.style.display = 'block';
                    userBalanceControl.scrollIntoView({ behavior: 'smooth' });
                });
            });
        }

        function saveUserBalance() {
            const username = selectedUsername.textContent;
            const balance = parseInt(newBalance.value);
            
            if (!username || isNaN(balance)) {
                alert('Введите корректное значение баланса');
                return;
            }
            
            const users = db.getUsers();
            if (!users[username]) {
                alert('Пользователь не найден');
                return;
            }
            
            users[username].balance = balance;
            db.saveUsers(users);
            
            if (currentUser === username) {
                updateUserDisplay();
            }
            
            alert(`Баланс пользователя ${username} изменен на ${balance}`);
            userBalanceControl.style.display = 'none';
            loadAdminUsers();
        }

        function loadSupportMessages() {
            const tickets = db.getSupportTickets();
            const openTickets = tickets.filter(ticket => ticket.status === 'open');
            
            supportMessagesCount.textContent = openTickets.length;
            
            if (openTickets.length === 0) {
                supportMessagesList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.5);">
                        <i class="fas fa-comment-slash" style="font-size: 32px; margin-bottom: 10px;"></i>
                        <p>Нет новых сообщений поддержки</p>
                    </div>
                `;
                adminReplyForm.classList.remove('active');
                chatResolvedButtons.classList.remove('active');
                return;
            }
            
            supportMessagesList.innerHTML = '';
            gameState.activeSupportTicket = openTickets[0];
            
            openTickets.forEach(ticket => {
                const messageElement = document.createElement('div');
                messageElement.className = 'support-message';
                messageElement.dataset.ticketId = ticket.id;
                
                messageElement.innerHTML = `
                    <div class="support-message-header">
                        <span class="support-message-user">${ticket.username}</span>
                        <span class="support-message-time">${ticket.date} ${ticket.time}</span>
                    </div>
                    <div class="support-message-text">${ticket.message}</div>
                    <button class="admin-btn-submit reply-btn" data-ticket-id="${ticket.id}" style="width: 100%; padding: 10px;">
                        <i class="fas fa-reply"></i> Ответить
                    </button>
                `;
                
                supportMessagesList.appendChild(messageElement);
            });
            
            document.querySelectorAll('.reply-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const ticketId = parseInt(btn.dataset.ticketId);
                    const ticket = tickets.find(t => t.id === ticketId);
                    
                    if (ticket) {
                        gameState.activeSupportTicket = ticket;
                        adminReplyForm.classList.add('active');
                        chatResolvedButtons.classList.add('active');
                        adminReplyForm.scrollIntoView({ behavior: 'smooth' });
                    }
                });
            });
        }

        function sendAdminReply() {
            const replyText = adminReplyText.value.trim();
            
            if (!replyText || !gameState.activeSupportTicket) {
                alert('Введите текст ответа');
                return;
            }
            
            const tickets = db.getSupportTickets();
            const ticketIndex = tickets.findIndex(t => t.id === gameState.activeSupportTicket.id);
            
            if (ticketIndex === -1) return;
            
            tickets[ticketIndex].replies.push({
                from: 'admin',
                message: replyText,
                time: new Date().toLocaleTimeString()
            });
            
            const adminMessages = db.getAdminMessages();
            const messageIndex = adminMessages.findIndex(msg => 
                msg.ticketId === gameState.activeSupportTicket.id && msg.isNew
            );
            
            if (messageIndex !== -1) {
                adminMessages[messageIndex].isNew = false;
                db.saveAdminMessages(adminMessages);
            }
            
            db.saveSupportTickets(tickets);
            adminReplyText.value = '';
            loadSupportMessages();
            updateAdminBadge();
            alert('Ответ отправлен пользователю!');
        }

        function markTicketResolved() {
            if (!gameState.activeSupportTicket) return;
            
            const tickets = db.getSupportTickets();
            const ticketIndex = tickets.findIndex(t => t.id === gameState.activeSupportTicket.id);
            
            if (ticketIndex === -1) return;
            
            tickets[ticketIndex].status = 'resolved';
            tickets[ticketIndex].resolvedAt = new Date().toISOString();
            
            tickets[ticketIndex].replies.push({
                from: 'admin',
                message: 'Спасибо за обращение, всего доброго!',
                time: new Date().toLocaleTimeString()
            });
            
            db.saveSupportTickets(tickets);
            
            const adminMessages = db.getAdminMessages();
            const updatedMessages = adminMessages.filter(msg => msg.ticketId !== gameState.activeSupportTicket.id);
            db.saveAdminMessages(updatedMessages);
            
            adminReplyForm.classList.remove('active');
            chatResolvedButtons.classList.remove('active');
            loadSupportMessages();
            updateAdminBadge();
            alert('Тикет помечен как решенный.');
        }

        function keepChatOpen() {
            adminReplyForm.classList.remove('active');
            chatResolvedButtons.classList.remove('active');
            adminReplyText.value = '';
            alert('Чат оставлен открытым. Вы можете вернуться к нему позже.');
        }

        function saveAdminSettings() {
            alert('Настройки успешно сохранены!');
        }

        // Загрузка кейсов
        function loadCases() {
            caseCardsContainer.innerHTML = '';
            
            Object.keys(casesData).forEach(caseId => {
                const caseData = casesData[caseId];
                const caseCard = document.createElement('div');
                caseCard.className = 'case-card';
                caseCard.dataset.case = caseId;
                caseCard.style.borderColor = caseData.color;
                
                // Создаем свое изображение для кейса
                let caseImage;
                switch(caseId) {
                    case '1': caseImage = '<div class="case-army"></div>'; break;
                    case '2': caseImage = '<div class="case-forbidden"></div>'; break;
                    case '3': caseImage = '<div class="case-secret"></div>'; break;
                    case '4': caseImage = '<div class="case-classified"></div>'; break;
                    case '5': caseImage = '<div class="case-knife"></div>'; break;
                }
                
                caseCard.innerHTML = `
                    <div class="case-image" style="background: linear-gradient(135deg, ${caseData.color}20, #1e2328);">
                        ${caseImage}
                    </div>
                    <div class="case-info">
                        <div class="case-name">${caseData.name}</div>
                        <div class="case-price">
                            <i class="fas fa-coins"></i> 
                            <span class="case-price-value">${caseData.price.toLocaleString()}</span>
                        </div>
                        <div class="case-items">
                            <span>${caseData.items.length} предметов</span>
                        </div>
                        <div class="open-case-section">
                            <button class="open-case-btn" data-case="${caseId}" disabled>
                                <i class="fas fa-lock"></i> Войдите для открытия
                            </button>
                            <div class="case-stats">
                                <div class="stat"><i class="fas fa-box-open"></i> ${caseData.items.length} предметов</div>
                                <div class="stat"><i class="fas fa-palette"></i> ${caseData.name}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                caseCard.addEventListener('click', function() {
                    const caseId = parseInt(this.dataset.case);
                    openCaseView(caseId);
                });
                
                caseCardsContainer.appendChild(caseCard);
            });
            
            updateOpenCaseButtons();
        }

        // Открытие вида кейса
        function openCaseView(caseId) {
            if (!currentUser) {
                authModal.style.display = 'flex';
                return;
            }
            
            gameState.selectedCase = caseId;
            const caseData = casesData[caseId];
            
            resetCaseOpeningView();
            openingCaseName.textContent = caseData.name;
            updateSpinButtonPrice();
            initItemsPreview(caseData);
            
            caseOpeningSection.classList.add('active');
            caseSelection.style.display = 'none';
            profileSection.style.display = 'none';
            upgradeSection.style.display = 'none';
            contractSection.style.display = 'none';
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Инициализация превью предметов
        function initItemsPreview(caseData) {
            itemsPreview.innerHTML = '';
            
            const uniqueItems = [];
            const seen = new Set();
            
            caseData.items.forEach(item => {
                if (!seen.has(item.name)) {
                    seen.add(item.name);
                    uniqueItems.push(item);
                }
            });
            
            uniqueItems.sort((a, b) => b.value - a.value);
            uniqueItems.slice(0, 12).forEach(item => {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                
                const rarity = item.rarity;
                const rarityColor = getRarityColor(rarity);
                
                previewItem.style.borderColor = rarityColor;
                
                // Разбиваем название на несколько строк
                const words = item.name.split(' ');
                let displayName = '';
                for (let i = 0; i < words.length; i++) {
                    displayName += words[i] + (i % 2 === 1 ? '\n' : ' ');
                }
                
                previewItem.innerHTML = `
                    <div class="item-img item-${rarity}"></div>
                    <div class="preview-name">${displayName}</div>
                    <div class="preview-price">${item.value} <i class="fas fa-coins"></i></div>
                `;
                
                previewItem.classList.add(`rarity-${rarity}`);
                itemsPreview.appendChild(previewItem);
            });
        }

        function updateUserDisplay() {
            if (!currentUser) {
                userBalanceSpan.textContent = "0";
                userAvatarBtn.querySelector('img').src = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
                return;
            }
            
            const user = db.getUser(currentUser);
            if (!user) return;
            
            userBalanceSpan.textContent = user.balance.toLocaleString();
            updateAvatar(currentUser, userAvatarBtn.querySelector('img'));
        }

        function updateAvatar(username, imgElement) {
            const colors = ['#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2', '#EF476F'];
            const colorIndex = username.length % colors.length;
            const avatarColor = colors[colorIndex];
            
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = avatarColor;
            ctx.fillRect(0, 0, 100, 100);
            
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 40px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            const initials = username.substring(0, 2).toUpperCase();
            ctx.fillText(initials, 50, 50);
            
            const avatarUrl = canvas.toDataURL();
            imgElement.src = avatarUrl;
        }

        function updateOnlineCount() {
            const count = Math.floor(Math.random() * 100) + 152;
            onlineCount.textContent = count;
        }

        function updateOpenCaseButtons() {
            const isLoggedIn = currentUser !== null;
            
            document.querySelectorAll('.open-case-btn').forEach(btn => {
                if (isLoggedIn) {
                    btn.disabled = false;
                    btn.innerHTML = `<i class="fas fa-box-open"></i> Открыть кейс`;
                } else {
                    btn.disabled = true;
                    btn.innerHTML = `<i class="fas fa-lock"></i> Войдите для открытия`;
                }
            });
            
            spinBtn.disabled = !isLoggedIn;
        }

        // Авторизация
        function login() {
            const username = loginUsername.value.trim();
            const password = loginPassword.value;
            
            if (!username || !password) {
                loginError.textContent = "Введите логин и пароль";
                loginError.style.display = 'block';
                return;
            }
            
            const user = db.getUser(username);
            
            if (user && user.password === password) {
                currentUser = username;
                db.setCurrentUser(username);
                
                updateUserDisplay();
                updateOpenCaseButtons();
                authModal.style.display = 'none';
                loginUsername.value = '';
                loginPassword.value = '';
                loginError.style.display = 'none';
                
                profileTab.style.display = 'flex';
                if (user.isAdmin) {
                    adminBtn.classList.add('visible');
                }
                
                alert('Вы успешно вошли в аккаунт!');
            } else {
                loginError.textContent = "Неверный логин или пароль";
                loginError.style.display = 'block';
            }
        }

        function register() {
            const username = registerUsername.value.trim();
            const password = registerPassword.value;
            const confirm = registerConfirm.value;
            
            if (!username || !password || !confirm) {
                registerError.textContent = "Заполните все поля";
                registerError.style.display = 'block';
                return;
            }
            
            if (password !== confirm) {
                registerError.textContent = "Пароли не совпадают";
                registerError.style.display = 'block';
                return;
            }
            
            if (username.length < 3) {
                registerError.textContent = "Логин должен быть не менее 3 символов";
                registerError.style.display = 'block';
                return;
            }
            
            if (password.length < 6) {
                registerError.textContent = "Пароль должен быть не менее 6 символов";
                registerError.style.display = 'block';
                return;
            }
            
            if (db.getUser(username)) {
                registerError.textContent = "Логин уже занят";
                registerError.style.display = 'block';
                return;
            }
            
            const userData = {
                password: password,
                balance: systemSettings.defaultBalance,
                casesOpened: 0,
                totalValue: 0,
                bestItem: "Нет",
                createdAt: new Date().toLocaleDateString(),
                isAdmin: false,
                inventory: []
            };
            
            db.saveUser(username, userData);
            currentUser = username;
            db.setCurrentUser(username);
            
            updateUserDisplay();
            updateOpenCaseButtons();
            authModal.style.display = 'none';
            registerUsername.value = '';
            registerPassword.value = '';
            registerConfirm.value = '';
            registerError.style.display = 'none';
            
            profileTab.style.display = 'flex';
            
            alert('Аккаунт успешно создан! Вы вошли в систему.');
            loginTab.click();
        }

        // Вспомогательные функции
        function getAvatarColor(username) {
            const colors = ['#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2', '#EF476F'];
            const index = username.length % colors.length;
            return colors[index];
        }

        function getRarityColor(rarity) {
            const colors = {
                'common': '#5e98d9',
                'uncommon': '#4b69ff',
                'rare': '#8847ff',
                'mythical': '#d32ee6',
                'legendary': '#ffd700',
                'ancient': '#eb4b4b'
            };
            return colors[rarity] || '#969696';
        }

        function getRarityName(rarity) {
            const names = {
                'common': 'Армейское',
                'uncommon': 'Запрещенное',
                'rare': 'Засекреченное',
                'mythical': 'Тайное',
                'legendary': 'Ножевое',
                'ancient': 'Древнее'
            };
            return names[rarity] || rarity;
        }

        function getItemValue(itemName) {
            for (const rarity in cs2Items) {
                const item = cs2Items[rarity].find(i => i.name === itemName);
                if (item) return item.value;
            }
            return 0;
        }

        // Запуск инициализации
        document.addEventListener('DOMContentLoaded', init);
        window.addEventListener('resize', updateOnlineCount);
        setInterval(updateOnlineCount, 30000);
        updateOnlineCount();
    </script>
</body>
</html>

