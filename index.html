<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Telegram Web</title>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        :root {
            --bg-primary: #0c0c0c;
            --bg-secondary: #141414;
            --bg-tertiary: #1e1e1e;
            --bg-glass: rgba(30, 30, 30, 0.7);
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-blue: #2b9aff;
            --accent-green: #2b9a6b;
            --accent-purple: #9f7aea;
            --accent-red: #f56565;
            --border-color: #2a2a2a;
            --message-out: #1e4a7a;
            --message-in: #2a2a2a;
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—Ö–æ–¥–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 32px;
            width: 100%;
            max-width: 400px;
            background: #1a1a1a;
            border: 1px solid var(--border-color);
        }

        .modal-content h2 {
            margin-bottom: 24px;
            text-align: center;
            font-size: 28px;
            color: var(--accent-blue);
        }

        .modal-input {
            width: 100%;
            padding: 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
            margin-bottom: 16px;
        }

        .modal-input:focus {
            border-color: var(--accent-blue);
        }

        .modal-btn {
            background: var(--gradient-1);
            border: none;
            color: white;
            padding: 14px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .modal-btn:hover {
            transform: scale(1.02);
            opacity: 0.9;
        }

        .modal-btn.secondary {
            background: var(--bg-tertiary);
        }

        .auth-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .auth-tab.active {
            background: var(--gradient-1);
            color: white;
            border-color: transparent;
        }

        .password-input-container {
            position: relative;
            margin-bottom: 16px;
        }

        .toggle-password {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 18px;
        }

        .remember-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        .sidebar {
            width: 350px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--gradient-1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
            flex-shrink: 0;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-weight: 600;
            font-size: 16px;
        }

        .profile-status {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .online-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--accent-green);
            border-radius: 50%;
            margin-left: 6px;
        }

        .tabs {
            display: flex;
            padding: 16px;
            gap: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab.active {
            background: var(--gradient-1);
            color: white;
        }

        .search-bar {
            padding: 12px 16px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 30px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .create-chat-btn {
            position: absolute;
            right: 24px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--gradient-1);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
        }

        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            cursor: pointer;
            border-radius: 16px;
            margin-bottom: 4px;
        }

        .chat-item:hover {
            background: var(--bg-tertiary);
        }

        .chat-item.active {
            background: var(--bg-glass);
            border-left: 3px solid var(--accent-blue);
        }

        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--gradient-1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 20px;
            flex-shrink: 0;
        }

        .chat-details {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-last-message {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .chat-time {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .chat-unread {
            background: var(--accent-blue);
            color: white;
            font-size: 11px;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
        }

        /* –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }

        .chat-header {
            padding: 12px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-info {
            flex: 1;
        }

        .chat-title {
            font-weight: 600;
            font-size: 16px;
        }

        .chat-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 65%;
            display: flex;
            flex-direction: column;
        }

        .message.out {
            align-self: flex-end;
        }

        .message.in {
            align-self: flex-start;
        }

        .message-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 14px;
            word-wrap: break-word;
        }

        .message.out .message-bubble {
            background: var(--accent-blue);
            color: white;
        }

        .message.in .message-bubble {
            background: var(--bg-tertiary);
        }

        .message-time {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
            margin-left: 8px;
        }

        .message-input-container {
            padding: 16px 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 12px 18px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 30px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .send-btn {
            background: var(--gradient-1);
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }

        .logout-btn {
            padding: 16px;
            border-top: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <div class="modal active" id="loginModal">
        <div class="modal-content">
            <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="window.switchAuthMode('login')" id="loginTabBtn">–í—Ö–æ–¥</button>
                <button class="auth-tab" onclick="window.switchAuthMode('register')" id="registerTabBtn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>

            <div id="loginForm">
                <input type="text" class="modal-input" id="loginUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <div class="password-input-container">
                    <input type="password" class="modal-input" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
                    <button class="toggle-password" onclick="window.togglePassword('loginPassword')">üëÅÔ∏è</button>
                </div>
                <div class="remember-checkbox">
                    <input type="checkbox" id="rememberMe" checked>
                    <label for="rememberMe">–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</label>
                </div>
                <button class="modal-btn" onclick="window.login()">–í–æ–π—Ç–∏</button>
                <button class="modal-btn secondary" onclick="window.demoLogin()">–î–µ–º–æ-–¥–æ—Å—Ç—É–ø</button>
            </div>

            <div id="registerForm" style="display: none;">
                <input type="text" class="modal-input" id="registerUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <div class="password-input-container">
                    <input type="password" class="modal-input" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å">
                    <button class="toggle-password" onclick="window.togglePassword('registerPassword')">üëÅÔ∏è</button>
                </div>
                <div class="password-input-container">
                    <input type="password" class="modal-input" id="registerConfirmPassword" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                    <button class="toggle-password" onclick="window.togglePassword('registerConfirmPassword')">üëÅÔ∏è</button>
                </div>
                <div class="remember-checkbox">
                    <input type="checkbox" id="rememberMeRegister" checked>
                    <label for="rememberMeRegister">–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</label>
                </div>
                <button class="modal-btn" onclick="window.register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </div>
        </div>
    </div>

    <!-- –ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div class="app-container" id="appContainer" style="display: none;">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="avatar" id="profileAvatar" onclick="window.openProfileModal()">üë§</div>
                <div class="profile-info">
                    <div class="profile-name" id="profileName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="profile-status" id="profileStatusDisplay">–æ–Ω–ª–∞–π–Ω <span class="online-indicator"></span></div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="window.switchTab('chats')" id="tabChats">–ß–∞—Ç—ã</button>
                <button class="tab" onclick="window.switchTab('public')" id="tabPublic">–ü—É–±–ª–∏—á–Ω—ã–µ</button>
            </div>

            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫..." oninput="window.handleSearch()">
                <button class="create-chat-btn" onclick="window.openCreateChatModal()">+</button>
            </div>

            <div class="chats-list" id="chatsList"></div>
            
            <div class="logout-btn">
                <button class="modal-btn secondary" style="width: 100%;" onclick="window.logout()">–í—ã–π—Ç–∏</button>
            </div>
        </div>

        <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
        <div class="chat-area">
            <div class="chat-header">
                <div class="chat-info">
                    <div class="chat-title" id="currentChatName">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
                    <div class="chat-subtitle" id="chatStatus"></div>
                </div>
            </div>

            <div class="messages-container" id="messagesContainer"></div>

            <div class="message-input-container">
                <textarea 
                    class="message-input" 
                    id="messageInput" 
                    placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                    rows="1"
                    onkeydown="window.handleKeyPress(event)"
                ></textarea>
                <button class="send-btn" onclick="window.sendMessage()">‚û§</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞ -->
    <div class="modal" id="createChatModal">
        <div class="modal-content">
            <h2>–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</h2>
            <input type="text" class="modal-input" id="chatNameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞">
            <div class="password-input-container">
                <input type="password" class="modal-input" id="chatPasswordInput" placeholder="–ü–∞—Ä–æ–ª—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                <button class="toggle-password" onclick="window.togglePassword('chatPasswordInput')">üëÅÔ∏è</button>
            </div>
            <input type="text" class="modal-input" id="chatDescriptionInput" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
            <button class="modal-btn" onclick="window.createPublicChat()">–°–æ–∑–¥–∞—Ç—å</button>
            <button class="modal-btn secondary" onclick="window.closeCreateChatModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        const ADMIN_USERNAME = "K1lame";
        let currentUser = null;
        let users = JSON.parse(localStorage.getItem('telegram_users')) || {};
        let publicChats = JSON.parse(localStorage.getItem('publicChats')) || [];
        let myChats = [];
        let messages = JSON.parse(localStorage.getItem('messages')) || {};
        let unreadCounts = JSON.parse(localStorage.getItem('unreadCounts')) || {};
        let currentChat = null;
        let currentTab = 'chats';

        // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        if (!users['admin']) {
            users['admin'] = {
                id: 'user_1',
                name: 'admin',
                password: 'admin123',
                avatar: 'üë§'
            };
            localStorage.setItem('telegram_users', JSON.stringify(users));
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—Ö–æ–¥–∞
        window.switchAuthMode = function(mode) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const loginTab = document.getElementById('loginTabBtn');
            const registerTab = document.getElementById('registerTabBtn');
            
            if (mode === 'login') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                loginTab.className = 'auth-tab active';
                registerTab.className = 'auth-tab';
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                loginTab.className = 'auth-tab';
                registerTab.className = 'auth-tab active';
            }
        };

        window.togglePassword = function(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        };

        // –§—É–Ω–∫—Ü–∏—è –≤—Ö–æ–¥–∞
        window.login = function() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const remember = document.getElementById('rememberMe').checked;
            
            if (!username || !password) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –ø–∞—Ä–æ–ª—å');
                return;
            }
            
            const userKey = username.toLowerCase();
            if (users[userKey] && users[userKey].password === password) {
                const isAdmin = username === ADMIN_USERNAME;
                currentUser = {
                    id: users[userKey].id,
                    name: users[userKey].name,
                    avatar: users[userKey].avatar || 'üë§',
                    isAdmin: isAdmin
                };
                
                if (remember) {
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
                
                myChats = JSON.parse(localStorage.getItem(`myChats_${currentUser.id}`)) || [];
                
                document.getElementById('loginModal').classList.remove('active');
                document.getElementById('appContainer').style.display = 'flex';
                
                updateProfileUI();
                updateChatsList();
                
                console.log('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω:', currentUser);
            } else {
                alert('–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
            }
        };

        // –î–µ–º–æ-–≤—Ö–æ–¥
        window.demoLogin = function() {
            const demoUser = 'user_' + Math.random().toString(36).substr(2, 5);
            currentUser = {
                id: 'demo_' + Date.now(),
                name: '–ì–æ—Å—Ç—å_' + Math.random().toString(36).substr(2, 5),
                avatar: 'üë§',
                isAdmin: false
            };
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            myChats = [];
            
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('appContainer').style.display = 'flex';
            
            updateProfileUI();
            updateChatsList();
        };

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        window.register = function() {
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const remember = document.getElementById('rememberMeRegister').checked;
            
            if (!username || !password) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            if (password !== confirmPassword) {
                alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                return;
            }
            if (password.length < 3) {
                alert('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞');
                return;
            }
            
            const userKey = username.toLowerCase();
            if (users[userKey]) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
                return;
            }
            
            const isAdmin = username === ADMIN_USERNAME;
            const newUser = {
                id: 'user_' + Date.now() + Math.random().toString(36).substr(2, 5),
                name: username,
                password: password,
                avatar: 'üë§'
            };
            
            users[userKey] = newUser;
            localStorage.setItem('telegram_users', JSON.stringify(users));
            
            currentUser = {
                id: newUser.id,
                name: newUser.name,
                avatar: newUser.avatar,
                isAdmin: isAdmin
            };
            
            if (remember) {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
            
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('appContainer').style.display = 'flex';
            
            updateProfileUI();
            updateChatsList();
        };

        // –í—ã—Ö–æ–¥
        window.logout = function() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            currentChat = null;
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginModal').classList.add('active');
            
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('registerUsername').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('registerConfirmPassword').value = '';
        };

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
        function updateProfileUI() {
            if (!currentUser) return;
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileAvatar').textContent = currentUser.avatar || 'üë§';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
        window.updateChatsList = function() {
            const list = document.getElementById('chatsList');
            if (!list) return;
            
            list.innerHTML = '';
            
            let items = currentTab === 'chats' ? myChats : publicChats;
            
            if (items.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">–ù–µ—Ç —á–∞—Ç–æ–≤</div>';
                return;
            }
            
            items.forEach(chat => {
                const element = document.createElement('div');
                element.className = `chat-item ${currentChat?.id === chat.id ? 'active' : ''}`;
                element.onclick = () => joinChat(chat);
                
                const lastMsg = messages[chat.id]?.slice(-1)[0];
                
                element.innerHTML = `
                    <div class="chat-avatar">${chat.name?.charAt(0) || '?'}</div>
                    <div class="chat-details">
                        <div class="chat-name">${escapeHtml(chat.name)}</div>
                        <div class="chat-last-message">${lastMsg ? escapeHtml(lastMsg.text) : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div>
                    </div>
                    <div class="chat-meta">
                        <div class="chat-time">${lastMsg ? lastMsg.time : ''}</div>
                    </div>
                `;
                
                list.appendChild(element);
            });
        };

        // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ —á–∞—Ç—É
        function joinChat(chat) {
            if (!chat) return;
            
            if (!myChats.find(c => c.id === chat.id)) {
                myChats.push(chat);
                localStorage.setItem(`myChats_${currentUser.id}`, JSON.stringify(myChats));
            }
            
            currentChat = chat;
            document.getElementById('currentChatName').textContent = chat.name;
            document.getElementById('chatStatus').textContent = chat.description || '–ß–∞—Ç';
            
            renderMessages();
            updateChatsList();
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        window.sendMessage = function() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!currentChat) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç');
                return;
            }
            if (!text) return;
            
            const now = new Date();
            const timeString = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            const messageId = Date.now().toString();
            
            const message = {
                id: messageId,
                sender: currentUser.id,
                senderName: currentUser.name,
                text: text,
                time: timeString,
                timestamp: Date.now()
            };
            
            if (!messages[currentChat.id]) messages[currentChat.id] = [];
            messages[currentChat.id].push({ ...message, type: 'out' });
            
            localStorage.setItem('messages', JSON.stringify(messages));
            
            input.value = '';
            renderMessages();
            updateChatsList();
        };

        // –†–µ–Ω–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
        function renderMessages() {
            const container = document.getElementById('messagesContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!currentChat || !messages[currentChat.id]) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>';
                return;
            }
            
            messages[currentChat.id].forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.type}`;
                
                messageDiv.innerHTML = `
                    ${msg.type === 'in' ? `<div class="message-sender">${escapeHtml(msg.senderName)}</div>` : ''}
                    <div class="message-bubble">${escapeHtml(msg.text)}</div>
                    <div class="message-time">${msg.time}</div>
                `;
                
                container.appendChild(messageDiv);
            });
            
            container.scrollTop = container.scrollHeight;
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        window.switchTab = function(tab) {
            currentTab = tab;
            document.getElementById('tabChats').className = tab === 'chats' ? 'tab active' : 'tab';
            document.getElementById('tabPublic').className = tab === 'public' ? 'tab active' : 'tab';
            updateChatsList();
        };

        // –ü–æ–∏—Å–∫
        window.handleSearch = function() {
            updateChatsList();
        };

        // –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞
        window.openCreateChatModal = function() {
            document.getElementById('createChatModal').classList.add('active');
        };

        window.closeCreateChatModal = function() {
            document.getElementById('createChatModal').classList.remove('active');
            document.getElementById('chatNameInput').value = '';
            document.getElementById('chatPasswordInput').value = '';
            document.getElementById('chatDescriptionInput').value = '';
        };

        window.createPublicChat = function() {
            const name = document.getElementById('chatNameInput').value.trim();
            const password = document.getElementById('chatPasswordInput').value.trim();
            const description = document.getElementById('chatDescriptionInput').value.trim();
            
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞');
                return;
            }
            
            const newChat = {
                id: 'chat_' + Date.now() + Math.random().toString(36).substr(2, 5),
                name: name,
                description: description || '',
                password: password || null,
                createdBy: currentUser.id
            };
            
            publicChats.push(newChat);
            localStorage.setItem('publicChats', JSON.stringify(publicChats));
            
            joinChat(newChat);
            closeCreateChatModal();
        };

        window.openProfileModal = function() {
            alert('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
        };

        window.handleKeyPress = function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        };

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏
        function checkSavedSession() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    myChats = JSON.parse(localStorage.getItem(`myChats_${currentUser.id}`)) || [];
                    
                    document.getElementById('loginModal').classList.remove('active');
                    document.getElementById('appContainer').style.display = 'flex';
                    
                    updateProfileUI();
                    updateChatsList();
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Å—Å–∏–∏', e);
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        checkSavedSession();
    </script>
</body>
</html>
