<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–±—â–∏–π —á–∞—Ç</title>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, sans-serif; }
        body { background: #1a1a1a; color: white; height: 100vh; display: flex; }
        
        .sidebar {
            width: 250px;
            background: #2a2a2a;
            border-right: 1px solid #3a3a3a;
            display: flex;
            flex-direction: column;
        }
        
        .profile {
            padding: 20px;
            border-bottom: 1px solid #3a3a3a;
        }
        
        .avatar {
            width: 50px;
            height: 50px;
            background: #2ea6ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .username {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .online-count {
            color: #888;
            font-size: 14px;
        }
        
        .users-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #3a3a3a;
        }
        
        .user-avatar {
            width: 35px;
            height: 35px;
            background: #2ea6ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .online-dot {
            width: 8px;
            height: 8px;
            background: #2b7f4b;
            border-radius: 50%;
            display: inline-block;
            margin-left: 5px;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 20px;
            background: #2a2a2a;
            border-bottom: 1px solid #3a3a3a;
        }
        
        .chat-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .chat-status {
            color: #888;
            font-size: 14px;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            background: #2a2a2a;
            align-self: flex-start;
        }
        
        .message.out {
            background: #2ea6ff;
            align-self: flex-end;
        }
        
        .message-sender {
            font-size: 12px;
            color: #2ea6ff;
            margin-bottom: 3px;
        }
        
        .message-time {
            font-size: 10px;
            color: #888;
            text-align: right;
            margin-top: 3px;
        }
        
        .input-area {
            padding: 20px;
            background: #2a2a2a;
            border-top: 1px solid #3a3a3a;
            display: flex;
            gap: 10px;
        }
        
        .message-input {
            flex: 1;
            padding: 12px;
            background: #3a3a3a;
            border: none;
            border-radius: 24px;
            color: white;
            outline: none;
        }
        
        .send-btn {
            width: 45px;
            height: 45px;
            background: #2ea6ff;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        .login-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .login-box {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 20px;
            width: 300px;
        }
        
        .login-box h2 {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .login-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background: #3a3a3a;
            border: none;
            border-radius: 10px;
            color: white;
        }
        
        .login-btn {
            width: 100%;
            padding: 12px;
            background: #2ea6ff;
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
        }
        
        .tab-btn.active {
            color: white;
            border-bottom: 2px solid #2ea6ff;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="login-box">
            <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
            
            <div class="tabs">
                <button class="tab-btn active" onclick="showLogin()">–í—Ö–æ–¥</button>
                <button class="tab-btn" onclick="showRegister()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>
            
            <div id="loginForm">
                <input type="text" id="loginUsername" class="login-input" placeholder="–ò–º—è">
                <input type="password" id="loginPassword" class="login-input" placeholder="–ü–∞—Ä–æ–ª—å">
                <button class="login-btn" onclick="login()">–í–æ–π—Ç–∏</button>
            </div>
            
            <div id="registerForm" style="display: none;">
                <input type="text" id="regUsername" class="login-input" placeholder="–ò–º—è">
                <input type="password" id="regPassword" class="login-input" placeholder="–ü–∞—Ä–æ–ª—å">
                <input type="password" id="regConfirm" class="login-input" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                <button class="login-btn" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" style="display: none; width: 100%; display: flex;">
        <div class="sidebar">
            <div class="profile">
                <div class="avatar" id="profileAvatar">üë§</div>
                <div class="username" id="profileName"></div>
                <div class="online-count" id="onlineCount">0 –æ–Ω–ª–∞–π–Ω</div>
            </div>
            
            <div class="users-list" id="usersList"></div>
        </div>
        
        <div class="chat-area">
            <div class="chat-header">
                <div class="chat-title">–û–±—â–∏–π —á–∞—Ç</div>
                <div class="chat-status" id="chatStatus"></div>
            </div>
            
            <div class="messages" id="messages"></div>
            
            <div class="input-area">
                <input type="text" id="messageInput" class="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button class="send-btn" onclick="sendMessage()">‚Üí</button>
            </div>
        </div>
    </div>

    <script>
        // –í–ê–® –ö–õ–Æ–ß
        const ABLY_KEY = "pYHevw.VrFP9Q:8u3IGeMI56PtA4S6Z_VCVvvXpEXEmiIlfoAjfPb6BZg";
        
        let ably;
        let currentUser = null;
        let users = JSON.parse(localStorage.getItem('users')) || {};
        let onlineUsers = {};
        let messages = [];

        // –ü–†–û–í–ï–†–ö–ê –ö–õ–Æ–ß–ê - —Å—Ä–∞–∑—É –≤–∏–¥–Ω–æ, —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–ª–∏ –Ω–µ—Ç
        console.log("–ö–ª—é—á Ably:", ABLY_KEY);
        
        function initAbly() {
            if (!currentUser) return;
            
            ably = new Ably.Realtime({ 
                key: ABLY_KEY, 
                clientId: currentUser.id 
            });
            
            ably.connection.on('connected', () => {
                console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Ably!');
                
                // –ö–∞–Ω–∞–ª –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è
                const presence = ably.channels.get('presence');
                presence.presence.enter({ name: currentUser.name });
                
                presence.presence.subscribe('enter', (member) => {
                    if (member.clientId !== currentUser.id) {
                        onlineUsers[member.clientId] = member.data.name;
                        updateUsersList();
                    }
                });
                
                presence.presence.subscribe('leave', (member) => {
                    delete onlineUsers[member.clientId];
                    updateUsersList();
                });
                
                presence.presence.get((err, members) => {
                    members.forEach(m => {
                        if (m.clientId !== currentUser.id) {
                            onlineUsers[m.clientId] = m.data.name;
                        }
                    });
                    updateUsersList();
                });
                
                // –ö–∞–Ω–∞–ª —á–∞—Ç–∞
                const chat = ably.channels.get('general');
                chat.subscribe('message', (msg) => {
                    messages.push(msg.data);
                    if (messages.length > 50) messages.shift();
                    renderMessages();
                });
                
                chat.history({ limit: 50 }, (err, page) => {
                    if (page && page.items.length) {
                        messages = page.items.map(i => i.data);
                        renderMessages();
                    }
                });
            });
            
            ably.connection.on('failed', (err) => {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', err);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Ably. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á.');
            });
        }

        function updateUsersList() {
            const list = document.getElementById('usersList');
            const count = document.getElementById('onlineCount');
            const status = document.getElementById('chatStatus');
            
            list.innerHTML = '';
            const names = Object.values(onlineUsers);
            
            names.sort().forEach(name => {
                list.innerHTML += `
                    <div class="user-item">
                        <div class="user-avatar">üë§</div>
                        <div>${name} <span class="online-dot"></span></div>
                    </div>
                `;
            });
            
            count.textContent = `${names.length} –æ–Ω–ª–∞–π–Ω`;
            status.textContent = `${names.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
        }

        function renderMessages() {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            
            messages.forEach(msg => {
                const isMine = msg.sender === currentUser?.id;
                container.innerHTML += `
                    <div class="message ${isMine ? 'out' : ''}">
                        ${!isMine ? `<div class="message-sender">${msg.senderName}</div>` : ''}
                        <div>${msg.text}</div>
                        <div class="message-time">${msg.time}</div>
                    </div>
                `;
            });
            
            container.scrollTop = container.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text || !currentUser) return;
            
            const msg = {
                id: Date.now(),
                sender: currentUser.id,
                senderName: currentUser.name,
                text: text,
                time: new Date().toLocaleTimeString().slice(0,5)
            };
            
            const chat = ably?.channels.get('general');
            if (chat) {
                chat.publish('message', msg);
            }
            
            input.value = '';
        }

        function login() {
            const name = document.getElementById('loginUsername').value.trim();
            const pass = document.getElementById('loginPassword').value;
            
            const user = Object.values(users).find(u => u.name === name && u.pass === pass);
            if (user) {
                currentUser = { id: user.id, name: user.name };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                startApp();
            } else {
                alert('–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
            }
        }

        function register() {
            const name = document.getElementById('regUsername').value.trim();
            const pass = document.getElementById('regPassword').value;
            const confirm = document.getElementById('regConfirm').value;
            
            if (!name || !pass) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            if (pass !== confirm) return alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
            if (Object.values(users).some(u => u.name === name)) {
                return alert('–ò–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ');
            }
            
            const id = 'user_' + Date.now();
            users[id] = { id, name, pass };
            localStorage.setItem('users', JSON.stringify(users));
            
            currentUser = { id, name };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            startApp();
        }

        function startApp() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            document.getElementById('profileName').textContent = currentUser.name;
            initAbly();
        }

        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
            document.querySelectorAll('.tab-btn')[1].classList.remove('active');
        }

        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.querySelectorAll('.tab-btn')[0].classList.remove('active');
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Å–µ—Å—Å–∏—é
        const saved = localStorage.getItem('currentUser');
        if (saved) {
            currentUser = JSON.parse(saved);
            startApp();
        }
    </script>
</body>
</html>
