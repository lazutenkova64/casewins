<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Telegram Web</title>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        :root {
            --bg-primary: #0c0c0c;
            --bg-secondary: #141414;
            --bg-tertiary: #1e1e1e;
            --bg-glass: rgba(30, 30, 30, 0.7);
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-blue: #2b9aff;
            --accent-green: #2b9a6b;
            --accent-purple: #9f7aea;
            --accent-red: #f56565;
            --accent-orange: #f6ad55;
            --border-color: #2a2a2a;
            --message-out: #1e4a7a;
            --message-in: #2a2a2a;
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.2);
            --unread-badge: #2b9aff;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --admin-gold: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
            --toast-bg: rgba(20, 20, 20, 0.95);
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 20px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            margin: 0;
            background: radial-gradient(circle at 20% 30%, #1a1a2e, #0a0a0a);
        }

        .sidebar {
            width: 350px;
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            box-shadow: var(--shadow);
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(to right, rgba(43, 154, 255, 0.1), transparent);
            cursor: pointer;
            transition: background 0.2s;
        }
        .sidebar-header:hover {
            background: rgba(43, 154, 255, 0.15);
        }

        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--gradient-1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            object-fit: cover;
        }
        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }

        .profile-info {
            flex: 1;
            min-width: 0;
        }
        .profile-name {
            font-weight: 600;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .profile-status {
            font-size: 13px;
            color: var(--text-secondary);
        }
        .online-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--accent-green);
            border-radius: 50%;
            margin-left: 6px;
            box-shadow: 0 0 10px var(--accent-green);
        }
        .offline-indicator {
            background-color: var(--text-secondary);
            box-shadow: none;
        }

        .tabs {
            display: flex;
            padding: 16px 16px 12px;
            gap: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .tab {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            backdrop-filter: blur(5px);
        }
        .tab.active {
            background: var(--gradient-1);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .search-bar {
            padding: 12px 16px;
            position: relative;
        }
        .search-bar input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 30px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }
        .search-bar input:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(43, 154, 255, 0.2);
        }
        .create-chat-btn {
            position: absolute;
            right: 24px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--gradient-1);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
        }

        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        .chat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 16px;
            margin-bottom: 4px;
            position: relative;
        }
        .chat-item:hover {
            background: var(--bg-glass);
            transform: translateX(4px);
        }
        .chat-item.active {
            background: linear-gradient(90deg, var(--bg-glass), transparent);
            border-left: 3px solid var(--accent-blue);
        }
        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--gradient-2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 20px;
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }
        .chat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .chat-details {
            flex: 1;
            min-width: 0;
        }
        .chat-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-last-message {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
            flex-shrink: 0;
        }
        .chat-time { font-size: 11px; color: var(--text-secondary); }
        .chat-unread {
            background: var(--gradient-1);
            color: white;
            font-size: 11px;
            font-weight: 600;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            box-shadow: 0 2px 8px rgba(43, 154, 255, 0.3);
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: transparent;
            min-width: 0;
        }
        .chat-header {
            padding: 12px 20px;
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-sm);
        }
        .back-button {
            display: none;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .chat-info { flex: 1; min-width: 0; }
        .chat-title {
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-subtitle { font-size: 12px; color: var(--text-secondary); }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            scroll-behavior: smooth;
        }

        .message {
            max-width: 75%;
            display: flex;
            flex-direction: column;
            position: relative;
            opacity: 0;
            transform: translateY(20px);
            animation: messageAppear 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        @keyframes messageAppear {
            to { opacity: 1; transform: translateY(0); }
        }
        .message.out { align-self: flex-end; }
        .message.in { align-self: flex-start; }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 20px;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
            box-shadow: var(--shadow-sm);
        }
        .message.out .message-bubble {
            background: var(--gradient-1);
            border-bottom-right-radius: 4px;
            color: white;
        }
        .message.in .message-bubble {
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }
        .message-media {
            max-width: 300px;
            max-height: 300px;
            border-radius: 16px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .message-media:hover { transform: scale(1.02); }
        .message-sender {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-blue);
            margin-bottom: 4px;
            margin-left: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .message-time {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
            margin-left: 8px;
        }
        .message-actions {
            position: absolute;
            top: -30px;
            right: 0;
            display: none;
            gap: 4px;
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            padding: 6px 12px;
            border-radius: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            z-index: 10;
        }
        .message:hover .message-actions { display: flex; }
        .message-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 20px;
            transition: all 0.2s;
        }
        .message-action-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transform: scale(1.1);
        }

        .message-input-container {
            padding: 16px 20px;
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .input-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 0;
        }
        .message-input {
            width: 100%;
            padding: 12px 18px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 30px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            resize: none;
            max-height: 100px;
            min-height: 44px;
            transition: all 0.2s;
        }
        .message-input:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(43, 154, 255, 0.1);
        }

        .action-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: all 0.2s;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .action-btn:hover {
            background: var(--bg-secondary);
            color: var(--accent-blue);
            transform: scale(1.1);
        }
        .action-btn.recording {
            background: var(--accent-red);
            color: white;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } }

        .emoji-picker {
            display: flex;
            gap: 8px;
            padding: 12px;
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border-radius: 40px;
            border: 1px solid var(--border-color);
            margin-bottom: 8px;
            flex-wrap: wrap;
            justify-content: center;
            animation: slideDown 0.2s ease;
            max-height: 200px;
            overflow-y: auto;
        }
        .emoji-btn {
            background: none;
            border: none;
            font-size: 26px;
            cursor: pointer;
            padding: 6px;
            transition: all 0.2s;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .emoji-btn:hover { transform: scale(1.3); background: var(--bg-tertiary); }

        .send-btn {
            background: var(--gradient-1);
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            font-size: 18px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
        }
        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(43, 154, 255, 0.4);
        }

        /* РјРѕРґР°Р»СЊРЅС‹Рµ РѕРєРЅР° */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        .modal.active { display: flex; animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content {
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 28px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-content h2 {
            margin-bottom: 20px;
            text-align: center;
            font-size: 22px;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .modal-input {
            width: 100%;
            padding: 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
            margin-bottom: 16px;
        }
        .modal-input:focus { border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(43, 154, 255, 0.1); }
        .modal-btn {
            background: var(--gradient-1);
            border: none;
            color: white;
            padding: 14px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        .modal-btn.secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 28px;
            cursor: pointer;
            float: right;
            padding: 0 8px;
        }

        /* Р°РІР°С‚Р°СЂРєРё */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }
        .avatar-option {
            font-size: 36px;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0 auto;
            overflow: hidden;
        }
        .avatar-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .avatar-option:hover {
            transform: scale(1.1);
            border-color: var(--accent-blue);
            background: var(--bg-secondary);
        }
        .avatar-option.selected {
            border-color: var(--accent-green);
            box-shadow: 0 0 15px var(--accent-green);
        }
        .upload-avatar-btn {
            grid-column: span 4;
            background: var(--bg-tertiary);
            border: 1px dashed var(--accent-blue);
            border-radius: 30px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            color: var(--accent-blue);
        }

        /* СЃС‚Р°С‚СѓСЃ-СЃРµР»РµРєС‚РѕСЂ */
        .status-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            justify-content: center;
        }
        .status-option {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 30px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .status-option.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        /* СѓРІРµРґРѕРјР»РµРЅРёСЏ */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--toast-bg);
            backdrop-filter: blur(10px);
            border-left: 4px solid var(--accent-blue);
            border-radius: 12px;
            padding: 12px 16px;
            max-width: 300px;
            box-shadow: var(--shadow);
            color: var(--text-primary);
            z-index: 3000;
            animation: slideInRight 0.3s ease;
            cursor: pointer;
        }
        .toast-notification:hover { opacity: 0.9; }
        .toast-notification.fade-out { animation: fadeOut 0.3s ease forwards; }
        @keyframes slideInRight {
            from { transform: translateX(120%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut { to { opacity: 0; transform: translateX(120%); } }

        /* РјРµРґРёР°-РІСЊСЋРµСЂ */
        .media-viewer {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .media-viewer.active { display: flex; }
        .media-viewer-content { max-width: 90%; max-height: 90%; }
        .media-viewer-content img, .media-viewer-content video {
            width: 100%; height: 100%; object-fit: contain; border-radius: 12px;
        }
        .media-viewer-close {
            position: absolute; top: 20px; right: 20px;
            background: var(--bg-glass); border: 1px solid var(--border-color);
            color: white; font-size: 32px; cursor: pointer;
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }

        .admin-badge {
            background: var(--admin-gold); color: #000; font-size: 11px;
            padding: 3px 10px; border-radius: 16px; margin-left: 6px;
            font-weight: bold; display: inline-block;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed; left: 0; top: 0; bottom: 0; z-index: 1000;
                transform: translateX(-100%); width: 85%; max-width: 320px;
            }
            .sidebar.active { transform: translateX(0); }
            .back-button { display: block; }
        }
    </style>
</head>
<body>
    <!-- РњРµРґРёР° РїСЂРѕСЃРјРѕС‚СЂС‰РёРє -->
    <div class="media-viewer" id="mediaViewer" onclick="closeMediaViewer()">
        <div class="media-viewer-content" id="mediaViewerContent"></div>
        <button class="media-viewer-close" onclick="closeMediaViewer()">Г—</button>
    </div>

    <!-- РњРѕРґР°Р»РєР° РІС…РѕРґР°/СЂРµРіРёСЃС‚СЂР°С†РёРё -->
    <div class="modal active" id="loginModal">
        <div class="modal-content">
            <h2>Р”РѕР±СЂРѕ РїРѕР¶Р°Р»РѕРІР°С‚СЊ!</h2>
            <div class="auth-tabs" style="display:flex; gap:8px; margin-bottom:24px;">
                <button class="auth-tab active" onclick="switchAuthMode('login')" id="loginTabBtn" style="flex:1; padding:12px; background:none; border:none; color:var(--text-secondary); border-radius:12px;">Р’С…РѕРґ</button>
                <button class="auth-tab" onclick="switchAuthMode('register')" id="registerTabBtn" style="flex:1; padding:12px; background:none; border:none; color:var(--text-secondary); border-radius:12px;">Р РµРіРёСЃС‚СЂР°С†РёСЏ</button>
            </div>
            <div id="loginForm">
                <input type="text" class="modal-input" id="loginUsername" placeholder="РРјСЏ РїРѕР»СЊР·РѕРІР°С‚РµР»СЏ" autocomplete="off">
                <div class="password-input-container" style="position:relative;">
                    <input type="password" class="modal-input" id="loginPassword" placeholder="РџР°СЂРѕР»СЊ">
                    <button class="toggle-password" onclick="togglePassword('loginPassword')" style="position:absolute; right:14px; top:50%; transform:translateY(-50%); background:none; border:none; color:var(--text-secondary);">рџ‘ЃпёЏ</button>
                </div>
                <div class="remember-checkbox" style="display:flex; align-items:center; gap:8px; margin-bottom:20px;">
                    <input type="checkbox" id="rememberMe" checked> <label for="rememberMe">Р—Р°РїРѕРјРЅРёС‚СЊ РјРµРЅСЏ</label>
                </div>
                <button class="modal-btn" onclick="login()">Р’РѕР№С‚Рё</button>
            </div>
            <div id="registerForm" style="display:none;">
                <input type="text" class="modal-input" id="registerUsername" placeholder="РРјСЏ РїРѕР»СЊР·РѕРІР°С‚РµР»СЏ" maxlength="20">
                <input type="email" class="modal-input" id="registerEmail" placeholder="Email" maxlength="50">
                <div class="password-input-container" style="position:relative;">
                    <input type="password" class="modal-input" id="registerPassword" placeholder="РџР°СЂРѕР»СЊ">
                    <button class="toggle-password" onclick="togglePassword('registerPassword')" style="position:absolute; right:14px; top:50%; transform:translateY(-50%);">рџ‘ЃпёЏ</button>
                </div>
                <div class="password-input-container" style="position:relative;">
                    <input type="password" class="modal-input" id="registerConfirmPassword" placeholder="РџРѕРґС‚РІРµСЂРґРёС‚Рµ РїР°СЂРѕР»СЊ">
                    <button class="toggle-password" onclick="togglePassword('registerConfirmPassword')" style="position:absolute; right:14px; top:50%; transform:translateY(-50%);">рџ‘ЃпёЏ</button>
                </div>
                <div class="remember-checkbox" style="display:flex; align-items:center; gap:8px; margin-bottom:20px;">
                    <input type="checkbox" id="rememberMeRegister" checked> <label for="rememberMeRegister">Р—Р°РїРѕРјРЅРёС‚СЊ РјРµРЅСЏ</label>
                </div>
                <button class="modal-btn" onclick="register()">Р—Р°СЂРµРіРёСЃС‚СЂРёСЂРѕРІР°С‚СЊСЃСЏ</button>
            </div>
        </div>
    </div>

    <!-- РћСЃРЅРѕРІРЅРѕРµ РїСЂРёР»РѕР¶РµРЅРёРµ -->
    <div class="app-container" id="appContainer" style="display: none;">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header" onclick="openProfileModal()">
                <div class="avatar" id="profileAvatar">рџ‘¤</div>
                <div class="profile-info">
                    <div class="profile-name" id="profileName">Р—Р°РіСЂСѓР·РєР°...</div>
                    <div class="profile-status" id="profileStatusText">РѕРЅР»Р°Р№РЅ</div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('chats')" id="tabChats">РњРѕРё С‡Р°С‚С‹</button>
                <button class="tab" onclick="switchTab('public')" id="tabPublic">РџСѓР±Р»РёС‡РЅС‹Рµ</button>
                <button class="tab" onclick="switchTab('users')" id="tabUsers">РџРѕР»СЊР·РѕРІР°С‚РµР»Рё</button>
            </div>

            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="РџРѕРёСЃРє..." oninput="handleSearch()">
                <button class="create-chat-btn" onclick="openCreateChatModal()">+</button>
            </div>

            <div class="chats-list" id="chatsList"></div>
            <!-- РљРЅРѕРїРєР° РІС‹С…РѕРґР° СѓР±СЂР°РЅР° РѕС‚СЃСЋРґР° -->
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <button class="back-button" onclick="toggleSidebar()">в†ђ</button>
                <div class="chat-info">
                    <div class="chat-title" id="currentChatName">Р’С‹Р±РµСЂРёС‚Рµ С‡Р°С‚</div>
                    <div class="chat-subtitle" id="chatStatus"></div>
                </div>
                <!-- РёРєРѕРЅРєР° РїСЂРѕС„РёР»СЏ СѓРґР°Р»РµРЅР° -->
            </div>

            <div class="messages-container" id="messagesContainer"></div>

            <div class="message-input-container">
                <button class="action-btn" onclick="toggleEmojiPicker()">рџЉ</button>
                <button class="action-btn" onclick="toggleRecording()" id="micBtn">рџЋ¤</button>
                <button class="action-btn" onclick="document.getElementById('fileInput').click()">рџ“Ћ</button>
                <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleFileSelect(event)">
                <div class="input-wrapper">
                    <div class="emoji-picker" id="emojiPicker" style="display: none;">
                        <!-- Р±РѕР»СЊС€РѕР№ РЅР°Р±РѕСЂ СЌРјРѕРґР·Рё Р±СѓРґРµС‚ РІСЃС‚Р°РІР»РµРЅ СЃРєСЂРёРїС‚РѕРј -->
                    </div>
                    <textarea class="message-input" id="messageInput" placeholder="РќР°РїРёС€РёС‚Рµ СЃРѕРѕР±С‰РµРЅРёРµ..." rows="1" onkeydown="handleKeyPress(event)"></textarea>
                </div>
                <button class="send-btn" onclick="sendMessage()">вћ¤</button>
            </div>
        </div>
    </div>

    <!-- РњРѕРґР°Р»РєР° СЃРѕР·РґР°РЅРёСЏ С‡Р°С‚Р° -->
    <div class="modal" id="createChatModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeCreateChatModal()">Г—</button>
            <h2>РЎРѕР·РґР°С‚СЊ РїСѓР±Р»РёС‡РЅС‹Р№ С‡Р°С‚</h2>
            <input type="text" class="modal-input" id="chatNameInput" placeholder="РќР°Р·РІР°РЅРёРµ С‡Р°С‚Р°" maxlength="30">
            <div class="password-input-container" style="position:relative;">
                <input type="password" class="modal-input" id="chatPasswordInput" placeholder="РџР°СЂРѕР»СЊ (РЅРµРѕР±СЏР·Р°С‚РµР»СЊРЅРѕ)">
                <button class="toggle-password" onclick="togglePassword('chatPasswordInput')" style="position:absolute; right:14px; top:50%; transform:translateY(-50%);">рџ‘ЃпёЏ</button>
            </div>
            <input type="text" class="modal-input" id="chatDescriptionInput" placeholder="РћРїРёСЃР°РЅРёРµ (РЅРµРѕР±СЏР·Р°С‚РµР»СЊРЅРѕ)">
            <button class="modal-btn" onclick="createPublicChat()">РЎРѕР·РґР°С‚СЊ С‡Р°С‚</button>
        </div>
    </div>

    <!-- РњРѕРґР°Р»РєР° РІС…РѕРґР° РІ Р·Р°С‰РёС‰С‘РЅРЅС‹Р№ С‡Р°С‚ -->
    <div class="modal" id="joinChatModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeJoinChatModal()">Г—</button>
            <h2 id="joinChatTitle">Р’РІРµРґРёС‚Рµ РїР°СЂРѕР»СЊ</h2>
            <div class="password-input-container" style="position:relative;">
                <input type="password" class="modal-input" id="joinPasswordInput" placeholder="РџР°СЂРѕР»СЊ С‡Р°С‚Р°">
                <button class="toggle-password" onclick="togglePassword('joinPasswordInput')" style="position:absolute; right:14px; top:50%; transform:translateY(-50%);">рџ‘ЃпёЏ</button>
            </div>
            <button class="modal-btn" onclick="joinProtectedChat()">Р’РѕР№С‚Рё</button>
        </div>
    </div>

    <!-- РњРѕРґР°Р»РєР° СЂРµРґР°РєС‚РёСЂРѕРІР°РЅРёСЏ СЃРѕРѕР±С‰РµРЅРёСЏ -->
    <div class="modal" id="editMessageModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeEditMessageModal()">Г—</button>
            <h2>Р РµРґР°РєС‚РёСЂРѕРІР°С‚СЊ СЃРѕРѕР±С‰РµРЅРёРµ</h2>
            <textarea class="modal-input" id="editMessageText" rows="3" style="resize:none;"></textarea>
            <button class="modal-btn" onclick="saveEditedMessage()">РЎРѕС…СЂР°РЅРёС‚СЊ</button>
        </div>
    </div>

    <!-- РњРѕРґР°Р»РєР° РїСЂРѕС„РёР»СЏ (СЂРµРґР°РєС‚РёСЂРѕРІР°РЅРёРµ) -->
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeProfileModal()">Г—</button>
            <h2>РњРѕР№ РїСЂРѕС„РёР»СЊ</h2>
            <div style="text-align:center; margin-bottom:20px;">
                <div class="avatar" style="width:80px; height:80px; font-size:42px; margin:0 auto; cursor:pointer;" id="profileAvatarLarge" onclick="openAvatarModal()">рџ‘¤</div>
            </div>
            <input type="text" class="modal-input" id="profileNameInput" placeholder="РРјСЏ (РЅРёРєРЅРµР№Рј)">
            <input type="email" class="modal-input" id="profileEmailInput" placeholder="Email" readonly disabled style="background:var(--bg-secondary);">
            <div class="status-selector" id="statusSelector">
                <div class="status-option active" data-status="online" onclick="setStatus('online')">рџџў Р’ СЃРµС‚Рё</div>
                <div class="status-option" data-status="offline" onclick="setStatus('offline')">вљЄ РќРµ РІ СЃРµС‚Рё</div>
                <div class="status-option" data-status="dnd" onclick="setStatus('dnd')">рџ”ґ РќРµ Р±РµСЃРїРѕРєРѕРёС‚СЊ</div>
            </div>
            <button class="modal-btn" onclick="saveProfile()">РЎРѕС…СЂР°РЅРёС‚СЊ</button>
            <button class="modal-btn secondary" onclick="openAvatarModal()">Р’С‹Р±СЂР°С‚СЊ Р°РІР°С‚Р°СЂ</button>
            <button class="modal-btn secondary" style="background:var(--accent-red); color:white;" onclick="logout()">Р’С‹Р№С‚Рё</button>
        </div>
    </div>

    <!-- РњРѕРґР°Р»РєР° РІС‹Р±РѕСЂР° Р°РІР°С‚Р°СЂР° -->
    <div class="modal" id="avatarModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeAvatarModal()">Г—</button>
            <h2>Р’С‹Р±РµСЂРёС‚Рµ Р°РІР°С‚Р°СЂ</h2>
            <div class="avatar-grid" id="avatarGrid"></div>
            <div class="upload-avatar-btn" onclick="uploadCustomAvatar()">рџ“Ѓ Р—Р°РіСЂСѓР·РёС‚СЊ СЃРІРѕС‘ С„РѕС‚Рѕ</div>
            <button class="modal-btn" onclick="saveAvatar()">РЎРѕС…СЂР°РЅРёС‚СЊ</button>
        </div>
    </div>

    <script>
        // ============================================================
        // ABLY API KEY
        // ============================================================
        const ABLY_API_KEY = "pYHevw.VrFP9Q:8u3IGeMI56PtA4S6Z_VCVvvXpEXEmiIlfoAjfPb6BZg";

        // ---------------------- Р“Р»РѕР±Р°Р»СЊРЅС‹Рµ РїРµСЂРµРјРµРЅРЅС‹Рµ ----------------------
        let ably;
        let currentUser = null;
        let users = JSON.parse(localStorage.getItem('telegram_users')) || {};
        let publicChats = JSON.parse(localStorage.getItem('publicChats')) || [];
        let myChats = [];
        let onlineUsers = {};          // РґР»СЏ presence (СЂРµР°Р»СЊРЅС‹Р№ СЃС‚Р°С‚СѓСЃ)
        let userStatus = {};            // С…СЂР°РЅРёРј Р¶РµР»Р°РµРјС‹Р№ СЃС‚Р°С‚СѓСЃ РїРѕР»СЊР·РѕРІР°С‚РµР»РµР№ (online/offline/dnd)
        let currentChat = null;
        let messages = JSON.parse(localStorage.getItem('messages')) || {};
        let unreadCounts = JSON.parse(localStorage.getItem('unreadCounts')) || {};
        let currentTab = 'chats';
        let pendingChatToJoin = null;
        let messageToEdit = null;
        const ADMIN_USERNAME = "K1lame";
        let deletedMessages = JSON.parse(localStorage.getItem('deletedMessages')) || {};

        // Р”Р»СЏ Р°СѓРґРёРѕР·Р°РїРёСЃРё
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let recordingStartTime;

        // Р—Р°С‰РёС‚Р° РѕС‚ С„Р»СѓРґР°
        let messageCooldown = false;
        let loginAttempts = {}; // email: {count, timestamp}

        // РЈРІРµРґРѕРјР»РµРЅРёСЏ
        let notificationPermission = false;
        if (Notification && Notification.permission !== 'granted') {
            Notification.requestPermission();
        }

        // Р‘РѕР»СЊС€РѕР№ РЅР°Р±РѕСЂ СЌРјРѕРґР·Рё
        const emojiList = ['рџЂ','рџѓ','рџ„','рџЃ','рџ†','рџ…','рџ‚','рџ¤Ј','рџЉ','рџ‡','рџ™‚','рџ™ѓ','рџ‰','рџЊ','рџЌ','рџҐ°','рџ','рџ—','рџ™','рџљ','рџ‹','рџ›','рџќ','рџњ','рџ¤Є','рџ¤Ё','рџ§ђ','рџ¤“','рџЋ','рџҐё','рџ¤©','рџҐі','рџЏ','рџ’','рџћ','рџ”','рџџ','рџ•','рџ™Ѓ','в№пёЏ','рџЈ','рџ–','рџ«','рџ©','рџҐє','рџў','рџ­','рџ¤','рџ ','рџЎ','рџ¤¬','рџ¤Ї','рџі','рџҐµ','рџҐ¶','рџ±','рџЁ','рџ°','рџҐ','рџ“','рџ¤—','рџ¤”','рџ¤­','рџ¤«','рџ¤Ґ','рџ¶','рџђ','рџ‘','рџ¬','рџ™„','рџЇ','рџ¦','рџ§','рџ®','рџІ','рџҐ±','рџґ','рџ¤¤','рџЄ','рџµ','рџ¤ђ','рџҐґ','рџ¤ў','рџ¤®','рџ¤§','рџ·','рџ¤’','рџ¤•','рџ¤‘','рџ¤ ','рџ€','рџ‘ї','рџ‘№','рџ‘є','рџ¤Ў','рџ’©','рџ‘»','рџ’Ђ','в пёЏ','рџ‘Ѕ','рџ‘ѕ','рџ¤–','рџЋѓ','рџє','рџё','рџ№','рџ»','рџј','рџЅ','рџ™Ђ','рџї','рџѕ','вќ¤пёЏ','рџ§Ў','рџ’›','рџ’љ','рџ’™','рџ’њ','рџ–¤','рџ¤Ќ','рџ¤Ћ','рџ’”','вќЈпёЏ','рџ’•','рџ’ћ','рџ’“','рџ’—','рџ’–','рџ’','рџ’ќ','рџ’џ','в®пёЏ','вњќпёЏ','вЄпёЏ','рџ•‰пёЏ','вёпёЏ','вњЎпёЏ','рџ”Ї','рџ•Ћ','вЇпёЏ','в¦пёЏ','рџ›ђ','в›Ћ','в™€','в™‰','в™Љ','в™‹','в™Њ','в™Ќ','в™Ћ','в™Џ','в™ђ','в™‘','в™’','в™“','рџ†”','вљ›пёЏ','рџ‰‘','вўпёЏ','вЈпёЏ','рџ“ґ','рџ“і','рџ€¶','рџ€љ','рџ€ё','рџ€є','рџ€·пёЏ','вњґпёЏ','рџ†љ','рџ’®','рџ‰ђ','гЉ™пёЏ','гЉ—пёЏ','рџ€ґ','рџ€µ','рџ€№','рџ€І','рџ…°пёЏ','рџ…±пёЏ','рџ†Ћ','рџ†‘','рџ…ѕпёЏ','рџ†','вќЊ','в­•','рџ›‘','в›”','рџ“›','рџљ«','рџ’Ї','рџ’ў','в™ЁпёЏ','рџљ·','рџљЇ','рџљі','рџљ±','рџ”ћ','рџ“µ','рџљ­','вќ—','вќ•','вќ“','вќ”','вќ•','вЂјпёЏ','вЃ‰пёЏ','рџ”…','рџ”†','гЂЅпёЏ','вљ пёЏ','рџљё','рџ”±','вљњпёЏ','рџ”°','в™»пёЏ','вњ…','рџ€ЇпёЏ','рџ’№','вќ‡пёЏ','вњіпёЏ','вќЋ','рџЊђ','рџ’ ','в“‚пёЏ','рџЊЂ','рџ’¤','рџЏ§','рџљ®','в™їпёЏ','рџљ№','рџљє','рџљј','рџљ»','рџљ°','рџљѕ','рџ›‚','рџ›ѓ','рџ›„','рџ›…','вљ пёЏ','рџљё','вљ§пёЏ','рџЏіпёЏвЂЌрџЊ€','рџЏіпёЏвЂЌвљ§пёЏ'];

        // РЎС‚СЂР°РЅРЅС‹Рµ СЌРјРѕРґР·Рё РґР»СЏ Р°РІР°С‚Р°СЂР° (РѕСЃС‚Р°РІРёРј С‚Рµ Р¶Рµ)
        const weirdEmojis = ['рџ‘ѕ','рџ¤–','рџ‘Ѕ','рџ’Ђ','рџ‘»','рџ‘№','рџ‘є','рџ¤Ў','рџ’©','рџ”Ґ','рџЊЂ','рџЊљ','рџЊќ','в­ђ','рџЊџ','рџ’«','вњЁ','вљЎ','в„пёЏ','рџ’Ґ','рџ•іпёЏ','рџ‘ЃпёЏ','рџ§ ','рџ‘…','рџ‘„','рџ¦·','рџ¦ґ','рџ‘Ђ','рџ‘ѓ','рџ‘‚','рџЌ‘','рџЌ†','рџҐ‘','рџЊ®','рџЌ•','рџЌ”','рџЌџ','рџЊ­','рџЌї','рџҐЁ','рџ§Ђ','рџҐ©','рџҐ“','рџЌ—','рџЌ–','рџ¦ґ','рџҐЎ','рџҐў','рџЌЅпёЏ','рџ”Є','рџЄ“','вљ°пёЏ','вљ±пёЏ','рџ§ї','рџ”®','рџ“ї','рџ’Ћ','рџ”«','рџ’Ј','рџ§Ё','рџ›ЎпёЏ','рџЏ№','рџ—ЎпёЏ','вљ”пёЏ','рџ”§','рџ”Ё','в›ЏпёЏ','вљ’пёЏ','рџ› пёЏ','рџ”©'];

        // ---------------------- РРЅРёС†РёР°Р»РёР·Р°С†РёСЏ Рё СЃРµСЃСЃРёСЏ ----------------------
        function checkSavedSession() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    myChats = JSON.parse(localStorage.getItem(`myChats_${currentUser.id}`)) || [];
                    document.getElementById('loginModal').classList.remove('active');
                    document.getElementById('appContainer').style.display = 'flex';
                    updateProfileUI();
                    initAbly();
                    checkUrlForChat();
                } catch (e) { console.error('Failed to load session', e); }
            }
        }

        function updateProfileUI() {
            if (!currentUser) return;
            const nameSpan = document.getElementById('profileName');
            if (currentUser.isAdmin) {
                nameSpan.innerHTML = `${currentUser.name} <span class="admin-badge">ADMIN</span>`;
            } else {
                nameSpan.textContent = currentUser.name;
            }
            document.getElementById('profileAvatar').innerHTML = currentUser.avatar ? (currentUser.avatar.startsWith('data:') ? `<img src="${currentUser.avatar}">` : currentUser.avatar) : 'рџ‘¤';
            document.getElementById('profileAvatarLarge').innerHTML = currentUser.avatar ? (currentUser.avatar.startsWith('data:') ? `<img src="${currentUser.avatar}">` : currentUser.avatar) : 'рџ‘¤';
            document.getElementById('profileEmailInput').value = currentUser.email || '';
            // СЃС‚Р°С‚СѓСЃ
            const status = currentUser.status || 'online';
            document.querySelectorAll('.status-option').forEach(opt => opt.classList.remove('active'));
            document.querySelector(`.status-option[data-status="${status}"]`).classList.add('active');
            document.getElementById('profileStatusText').innerText = status === 'online' ? 'РѕРЅР»Р°Р№РЅ' : (status === 'offline' ? 'РЅРµ РІ СЃРµС‚Рё' : 'РЅРµ Р±РµСЃРїРѕРєРѕРёС‚СЊ');
        }

        // ---------------------- Ably ----------------------
        function initAbly() {
            if (!currentUser) return;
            ably = new Ably.Realtime({
                key: ABLY_API_KEY,
                clientId: currentUser.id,
                transports: ['web_socket'],
                disconnectedRetryTimeout: 1000,
                suspendedRetryTimeout: 2000
            });

            ably.connection.on('connected', () => {
                console.log('вњ… Connected to Ably');
                const presenceChannel = ably.channels.get('presence');
                // Р•СЃР»Рё СЃС‚Р°С‚СѓСЃ offline - РЅРµ РІС…РѕРґРёС‚СЊ РІ presence (РЅРµРІРёРґРёРјРєР°)
                if (currentUser.status !== 'offline') {
                    presenceChannel.presence.enter({ 
                        name: currentUser.name, 
                        avatar: currentUser.avatar || 'рџ‘¤',
                        bio: currentUser.bio || '',
                        isAdmin: currentUser.isAdmin,
                        status: currentUser.status || 'online'
                    });
                }
                presenceChannel.presence.subscribe('enter', (member) => {
                    if (member.clientId !== currentUser.id && member.data.status !== 'offline') {
                        onlineUsers[member.clientId] = {
                            id: member.clientId,
                            name: member.data.name,
                            avatar: member.data.avatar || 'рџ‘¤',
                            bio: member.data.bio || '',
                            online: true,
                            isAdmin: member.data.isAdmin || false
                        };
                        if (currentTab === 'users') updateChatsList();
                    }
                });
                presenceChannel.presence.subscribe('leave', (member) => {
                    delete onlineUsers[member.clientId];
                    if (currentTab === 'users') updateChatsList();
                });
                presenceChannel.presence.get((err, members) => {
                    members.forEach(member => {
                        if (member.clientId !== currentUser.id && member.data.status !== 'offline') {
                            onlineUsers[member.clientId] = {
                                id: member.clientId,
                                name: member.data.name,
                                avatar: member.data.avatar || 'рџ‘¤',
                                bio: member.data.bio || '',
                                online: true,
                                isAdmin: member.data.isAdmin || false
                            };
                        }
                    });
                    if (currentTab === 'users') updateChatsList();
                });

                // Р“Р»РѕР±Р°Р»СЊРЅС‹Рµ РєР°РЅР°Р»С‹
                const globalChatsChannel = ably.channels.get('global-chats');
                globalChatsChannel.subscribe('new-chat', (msg) => {
                    const newChat = msg.data;
                    if (!publicChats.find(c => c.id === newChat.id)) {
                        publicChats.push(newChat);
                        localStorage.setItem('publicChats', JSON.stringify(publicChats));
                        if (currentTab === 'public') updateChatsList();
                    }
                });

                const adminChannel = ably.channels.get('admin-actions');
                adminChannel.subscribe('delete-chat', (msg) => {
                    const { chatId } = msg.data;
                    publicChats = publicChats.filter(c => c.id !== chatId);
                    myChats = myChats.filter(c => c.id !== chatId);
                    localStorage.setItem('publicChats', JSON.stringify(publicChats));
                    localStorage.setItem(`myChats_${currentUser.id}`, JSON.stringify(myChats));
                    if (messages[chatId]) { delete messages[chatId]; localStorage.setItem('messages',JSON.stringify(messages)); }
                    if (currentChat && currentChat.id === chatId) {
                        currentChat = null;
                        document.getElementById('messagesContainer').innerHTML = '<div class="chat-deleted-message">вљ пёЏ Р§Р°С‚ СѓРґР°Р»РµРЅ Р°РґРјРёРЅРёСЃС‚СЂР°С‚РѕСЂРѕРј</div>';
                        document.getElementById('currentChatName').innerHTML = 'Р§Р°С‚ СѓРґР°Р»РµРЅ';
                    }
                    updateChatsList();
                });

                adminChannel.subscribe('delete-message', (msg) => {
                    const { chatId, messageId } = msg.data;
                    if (!deletedMessages[chatId]) deletedMessages[chatId] = [];
                    if (!deletedMessages[chatId].includes(messageId)) {
                        deletedMessages[chatId].push(messageId);
                        localStorage.setItem('deletedMessages', JSON.stringify(deletedMessages));
                    }
                    if (messages[chatId]) {
                        messages[chatId] = messages[chatId].filter(m => m.id !== messageId);
                        localStorage.setItem('messages', JSON.stringify(messages));
                        if (currentChat && currentChat.id === chatId) renderMessages();
                    }
                });

                myChats.forEach(chat => subscribeToChat(chat));
            });
            updateChatsList();
        }

        function subscribeToChat(chat) {
            const chatChannel = ably.channels.get(`chat-${chat.id}`);
            chatChannel.unsubscribe();
            chatChannel.subscribe('message', (msg) => {
                const message = msg.data;
                if (deletedMessages[chat.id] && deletedMessages[chat.id].includes(message.id)) return;
                if (!messages[chat.id]) messages[chat.id] = [];
                const exists = messages[chat.id].some(m => m.id === message.id);
                if (!exists) {
                    messages[chat.id].push({ ...message, type: message.sender === currentUser.id ? 'out' : 'in' });
                    messages[chat.id].sort((a,b) => (a.timestamp||0)-(b.timestamp||0));
                    localStorage.setItem('messages', JSON.stringify(messages));

                    // РџРѕРґРЅРёРјР°РµРј С‡Р°С‚ РІРІРµСЂС…
                    const chatIndex = myChats.findIndex(c => c.id === chat.id);
                    if (chatIndex !== -1) {
                        const chatObj = myChats.splice(chatIndex, 1)[0];
                        chatObj.lastMessageTime = Date.now();
                        myChats.unshift(chatObj);
                        localStorage.setItem(`myChats_${currentUser.id}`, JSON.stringify(myChats));
                    }

                    if (currentChat && currentChat.id === chat.id) {
                        renderMessages(true);
                        unreadCounts[chat.id] = 0;
                    } else if (message.sender !== currentUser.id) {
                        unreadCounts[chat.id] = (unreadCounts[chat.id] || 0) + 1;
                        // РЈРІРµРґРѕРјР»РµРЅРёРµ
                        showNotification(chat, message);
                    }
                    localStorage.setItem('unreadCounts', JSON.stringify(unreadCounts));
                    updateChatsList();
                }
            });
            chatChannel.subscribe('delete', (data) => {
                const { messageId } = data.data;
                if (!deletedMessages[chat.id]) deletedMessages[chat.id] = [];
                if (!deletedMessages[chat.id].includes(messageId)) {
                    deletedMessages[chat.id].push(messageId);
                    localStorage.setItem('deletedMessages', JSON.stringify(deletedMessages));
                }
                if (messages[chat.id]) {
                    messages[chat.id] = messages[chat.id].filter(m => m.id !== messageId);
                    localStorage.setItem('messages', JSON.stringify(messages));
                    if (currentChat?.id === chat.id) renderMessages(true);
                }
            });
            chatChannel.subscribe('edit', (data) => {
                const { messageId, newText } = data.data;
                if (messages[chat.id]) {
                    const idx = messages[chat.id].findIndex(m => m.id === messageId);
                    if (idx !== -1) {
                        messages[chat.id][idx].text = newText;
                        messages[chat.id][idx].edited = true;
                        localStorage.setItem('messages', JSON.stringify(messages));
                        if (currentChat?.id === chat.id) renderMessages(true);
                    }
                }
            });
            // history
            chatChannel.history({ limit: 200 }, (err, resultPage) => {
                if (resultPage && resultPage.items.length) {
                    if (!messages[chat.id]) messages[chat.id] = [];
                    resultPage.items.forEach(item => {
                        const msg = item.data;
                        if (deletedMessages[chat.id] && deletedMessages[chat.id].includes(msg.id)) return;
                        const exists = messages[chat.id].some(m => m.id === msg.id);
                        if (!exists) messages[chat.id].push({ ...msg, type: msg.sender === currentUser.id ? 'out' : 'in' });
                    });
                    messages[chat.id].sort((a,b) => (a.timestamp||0)-(b.timestamp||0));
                    localStorage.setItem('messages', JSON.stringify(messages));
                    if (currentChat?.id === chat.id) renderMessages(true);
                }
            });
        }

        // ---------------------- РЈРІРµРґРѕРјР»РµРЅРёСЏ ----------------------
        function showNotification(chat, message) {
            if (currentUser.status === 'dnd') return; // РЅРµ Р±РµСЃРїРѕРєРѕРёС‚СЊ
            const senderName = message.senderName || 'РџРѕР»СЊР·РѕРІР°С‚РµР»СЊ';
            const text = message.text || (message.media ? 'рџ“· Р¤РѕС‚Рѕ' : (message.audio ? 'рџЋ¤ Р“РѕР»РѕСЃРѕРІРѕРµ' : 'РЎРѕРѕР±С‰РµРЅРёРµ'));
            // Р•СЃР»Рё РІРєР»Р°РґРєР° Р°РєС‚РёРІРЅР° вЂ“ РїРѕРєР°Р·С‹РІР°РµРј РІСЃРїР»С‹РІР°С€РєСѓ СЃРїСЂР°РІР° СЃРЅРёР·Сѓ
            if (!document.hidden) {
                showToast(`${senderName}: ${text}`, chat);
            } else {
                // Р‘СЂР°СѓР·РµСЂРЅРѕРµ СѓРІРµРґРѕРјР»РµРЅРёРµ
                if (Notification && Notification.permission === 'granted') {
                    new Notification(`РЎРѕРѕР±С‰РµРЅРёРµ РѕС‚ ${senderName}`, { body: text, icon: '/favicon.ico' });
                }
            }
        }

        function showToast(text, chat) {
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.innerText = text;
            toast.onclick = () => { joinChat(chat); closeToast(toast); };
            document.body.appendChild(toast);
            setTimeout(() => closeToast(toast), 3000);
        }
        function closeToast(toast) {
            toast.classList.add('fade-out');
            setTimeout(() => toast.remove(), 300);
        }

        // ---------------------- РђСѓС‚РµРЅС‚РёС„РёРєР°С†РёСЏ ----------------------
        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const remember = document.getElementById('rememberMe').checked;
            if (!username || !password) { alert('Р’РІРµРґРёС‚Рµ РёРјСЏ Рё РїР°СЂРѕР»СЊ'); return; }
            const userKey = username.toLowerCase();
            if (users[userKey] && users[userKey].password === password) {
                const isAdmin = username === ADMIN_USERNAME;
                currentUser = {
                    id: users[userKey].id,
                    name: users[userKey].name,
                    avatar: users[userKey].avatar || 'рџ‘¤',
                    bio: users[userKey].bio || '',
                    email: users[userKey].email || '',
                    status: users[userKey].status || 'online',
                    isAdmin: isAdmin
                };
                if (remember) localStorage.setItem('currentUser', JSON.stringify(currentUser));
                myChats = JSON.parse(localStorage.getItem(`myChats_${currentUser.id}`)) || [];
                document.getElementById('loginModal').classList.remove('active');
                document.getElementById('appContainer').style.display = 'flex';
                updateProfileUI();
                initAbly();
                checkUrlForChat();
            } else alert('РќРµРІРµСЂРЅРѕРµ РёРјСЏ РёР»Рё РїР°СЂРѕР»СЊ');
        }

        function register() {
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim().toLowerCase();
            const password = document.getElementById('registerPassword').value;
            const confirm = document.getElementById('registerConfirmPassword').value;
            const remember = document.getElementById('rememberMeRegister').checked;
            if (!username || !email || !password) { alert('Р—Р°РїРѕР»РЅРёС‚Рµ РІСЃРµ РїРѕР»СЏ'); return; }
            if (password !== confirm) { alert('РџР°СЂРѕР»Рё РЅРµ СЃРѕРІРїР°РґР°СЋС‚'); return; }
            if (password.length < 3) { alert('РџР°СЂРѕР»СЊ РјРёРЅРёРјСѓРј 3 СЃРёРјРІРѕР»Р°'); return; }
            // РџСЂРѕРІРµСЂРєР° email РЅР° СѓРЅРёРєР°Р»СЊРЅРѕСЃС‚СЊ
            for (let key in users) {
                if (users[key].email === email) { alert('Р­С‚РѕС‚ email СѓР¶Рµ Р·Р°СЂРµРіРёСЃС‚СЂРёСЂРѕРІР°РЅ'); return; }
            }
            const userKey = username.toLowerCase();
            if (users[userKey]) { alert('РРјСЏ СѓР¶Рµ Р·Р°РЅСЏС‚Рѕ'); return; }
            const isAdmin = username === ADMIN_USERNAME;
            const newUser = {
                id: 'user_' + Date.now() + Math.random().toString(36).substr(2,5),
                name: username,
                email: email,
                password: password,
                avatar: 'рџ‘¤',
                bio: '',
                status: 'online',
                createdAt: new Date().toISOString()
            };
            users[userKey] = newUser;
            localStorage.setItem('telegram_users', JSON.stringify(users));
            currentUser = {
                id: newUser.id,
                name: newUser.name,
                avatar: newUser.avatar,
                bio: newUser.bio,
                email: newUser.email,
                status: 'online',
                isAdmin: isAdmin
            };
            if (remember) localStorage.setItem('currentUser', JSON.stringify(currentUser));
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('appContainer').style.display = 'flex';
            updateProfileUI();
            initAbly();
        }

        function logout() {
            if (ably) {
                const presenceChannel = ably.channels.get('presence');
                presenceChannel.presence.leave();
                ably.close();
            }
            localStorage.removeItem('currentUser');
            currentUser = null;
            currentChat = null;
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginModal').classList.add('active');
            updateUrlWithChat(null);
        }

        // ---------------------- Р Р°Р±РѕС‚Р° СЃ С‡Р°С‚Р°РјРё ----------------------
        function joinChat(chat) {
            if (!chat) return;
            if (chat.password && (!chat.members || !chat.members.includes(currentUser.id))) {
                pendingChatToJoin = chat;
                document.getElementById('joinChatTitle').textContent = `Р’РІРµРґРёС‚Рµ РїР°СЂРѕР»СЊ РґР»СЏ "${chat.name}"`;
                document.getElementById('joinChatModal').classList.add('active');
                return;
            }
            if (!chat.members) chat.members = [];
            if (!chat.members.includes(currentUser.id)) chat.members.push(currentUser.id);
            if (!myChats.find(c => c.id === chat.id)) {
                myChats.push(chat);
                localStorage.setItem(`myChats_${currentUser.id}`, JSON.stringify(myChats));
                if (ably) subscribeToChat(chat);
            }
            currentChat = chat;
            updateUrlWithChat(chat);
            let chatTitleHTML = `${chat.name} ${chat.password ? 'рџ”’' : ''}`;
            if (currentUser && currentUser.isAdmin) {
                chatTitleHTML += ` <button class="delete-chat-btn" onclick="deleteChat('${chat.id}', event)">РЈРґР°Р»РёС‚СЊ С‡Р°С‚</button>`;
            }
            document.getElementById('currentChatName').innerHTML = chatTitleHTML;
            document.getElementById('chatStatus').textContent = chat.description || 'Р§Р°С‚';
            if (!messages[chat.id]) messages[chat.id] = [];
            messages[chat.id].sort((a,b) => (a.timestamp||0)-(b.timestamp||0));
            unreadCounts[chat.id] = 0;
            localStorage.setItem('unreadCounts', JSON.stringify(unreadCounts));
            renderMessages(true);
            updateChatsList();
            if (window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('active');
        }

        function deleteChat(chatId, event) {
            event?.stopPropagation();
            if (!currentUser?.isAdmin) { alert('РўРѕР»СЊРєРѕ Р°РґРјРёРЅРёСЃС‚СЂР°С‚РѕСЂ'); return; }
            if (!confirm('РЈРґР°Р»РёС‚СЊ С‡Р°С‚?')) return;
            publicChats = publicChats.filter(c => c.id !== chatId);
            myChats = myChats.filter(c => c.id !== chatId);
            localStorage.setItem('publicChats', JSON.stringify(publicChats));
            localStorage.setItem(`myChats_${currentUser.id}`, JSON.stringify(myChats));
            if (messages[chatId]) { delete messages[chatId]; localStorage.setItem('messages',JSON.stringify(messages)); }
            if (ably) {
                const adminChannel = ably.channels.get('admin-actions');
                adminChannel.publish('delete-chat', { chatId, deletedBy: currentUser.id });
            }
            if (currentChat && currentChat.id === chatId) {
                currentChat = null;
                document.getElementById('messagesContainer').innerHTML = '<div class="chat-deleted-message">вљ пёЏ Р§Р°С‚ СѓРґР°Р»РµРЅ</div>';
                document.getElementById('currentChatName').innerHTML = 'Р§Р°С‚ СѓРґР°Р»РµРЅ';
            }
            updateChatsList();
        }

        function joinProtectedChat() {
            const pwd = document.getElementById('joinPasswordInput').value;
            if (pendingChatToJoin && pwd === pendingChatToJoin.password) {
                if (!pendingChatToJoin.members) pendingChatToJoin.members = [];
                pendingChatToJoin.members.push(currentUser.id);
                joinChat(pendingChatToJoin);
                closeJoinChatModal();
            } else alert('РќРµРІРµСЂРЅС‹Р№ РїР°СЂРѕР»СЊ');
        }

        function createPublicChat() {
            const name = document.getElementById('chatNameInput').value.trim();
            const password = document.getElementById('chatPasswordInput').value.trim();
            const desc = document.getElementById('chatDescriptionInput').value.trim();
            if (!name) { alert('Р’РІРµРґРёС‚Рµ РЅР°Р·РІР°РЅРёРµ'); return; }
            const newChat = {
                id: 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2,8),
                name: name,
                description: desc || '',
                password: password || null,
                createdBy: currentUser.id,
                createdByName: currentUser.name,
                members: [currentUser.id],
                createdAt: new Date().toISOString()
            };
            publicChats.push(newChat);
            localStorage.setItem('publicChats', JSON.stringify(publicChats));
            if (ably) {
                const globalChatsChannel = ably.channels.get('global-chats');
                globalChatsChannel.publish('new-chat', newChat);
            }
            joinChat(newChat);
            closeCreateChatModal();
        }

        // ---------------------- РћС‚РїСЂР°РІРєР° СЃРѕРѕР±С‰РµРЅРёР№ (С‚РµРєСЃС‚, С„РѕС‚Рѕ, Р°СѓРґРёРѕ) ----------------------
        function sendMessage(textOverride) {
            if (messageCooldown) { alert('РЎР»РёС€РєРѕРј С‡Р°СЃС‚Рѕ'); return; }
            const input = document.getElementById('messageInput');
            let text = textOverride !== undefined ? textOverride : input.value.trim();
            if (!currentChat) { alert('Р’С‹Р±РµСЂРёС‚Рµ С‡Р°С‚'); return; }
            if (!text && !pendingMedia) return;

            // Р·Р°С‰РёС‚Р° РѕС‚ С„Р»СѓРґР°
            messageCooldown = true;
            setTimeout(() => messageCooldown = false, 1000);

            if (!myChats.find(c => c.id === currentChat.id)) {
                myChats.push(currentChat);
                localStorage.setItem(`myChats_${currentUser.id}`, JSON.stringify(myChats));
                if (ably) subscribeToChat(currentChat);
            }

            const now = Date.now();
            const timeString = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const messageId = now + Math.random().toString(36).substr(2,5);
            const message = {
                id: messageId,
                chatId: currentChat.id,
                sender: currentUser.id,
                senderName: currentUser.name,
                text: text || null,
                time: timeString,
                timestamp: now,
                isAdmin: currentUser.isAdmin || false
            };

            // РµСЃР»Рё РµСЃС‚СЊ РјРµРґРёР° (С„РѕС‚Рѕ РёР»Рё Р°СѓРґРёРѕ)
            if (pendingMedia) {
                if (pendingMedia.type.startsWith('image')) {
                    message.media = { type: pendingMedia.type, url: pendingMedia.data };
                } else if (pendingMedia.type.startsWith('audio')) {
                    message.audio = { data: pendingMedia.data }; // base64
                }
                pendingMedia = null;
            }

            if (!messages[currentChat.id]) messages[currentChat.id] = [];
            messages[currentChat.id].push({ ...message, type: 'out' });
            messages[currentChat.id].sort((a,b) => (a.timestamp||0)-(b.timestamp||0));
            localStorage.setItem('messages', JSON.stringify(messages));

            // РїРѕРґРЅРёРјР°РµРј С‡Р°С‚
            const chatIndex = myChats.findIndex(c => c.id === currentChat.id);
            if (chatIndex !== -1) {
                const chatObj = myChats.splice(chatIndex, 1)[0];
                chatObj.lastMessageTime = now;
                myChats.unshift(chatObj);
                localStorage.setItem(`myChats_${currentUser.id}`, JSON.stringify(myChats));
            }

            if (ably) {
                const chatChannel = ably.channels.get(`chat-${currentChat.id}`);
                chatChannel.publish('message', message);
            }

            input.value = '';
            input.style.height = 'auto';
            renderMessages(true);
            updateChatsList();
        }

        let pendingMedia = null; // РґР»СЏ РІСЂРµРјРµРЅРЅРѕРіРѕ С…СЂР°РЅРµРЅРёСЏ РїРµСЂРµРґ РѕС‚РїСЂР°РІРєРѕР№
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) { alert('РўРѕР»СЊРєРѕ РёР·РѕР±СЂР°Р¶РµРЅРёСЏ'); return; }
            const reader = new FileReader();
            reader.onload = (e) => {
                pendingMedia = { type: file.type, data: e.target.result };
                sendMessage('рџ“· Р¤РѕС‚Рѕ'); // РјРѕР¶РЅРѕ РґРѕР±Р°РІРёС‚СЊ РїРѕРґРїРёСЃСЊ
            };
            reader.readAsDataURL(file);
        }

        // РђСѓРґРёРѕР·Р°РїРёСЃСЊ
        async function toggleRecording() {
            if (!currentChat) { alert('Р’С‹Р±РµСЂРёС‚Рµ С‡Р°С‚'); return; }
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }
        async function startRecording() {
            if (!navigator.mediaDevices) { alert('РњРёРєСЂРѕС„РѕРЅ РЅРµ РїРѕРґРґРµСЂР¶РёРІР°РµС‚СЃСЏ'); return; }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.onload = () => {
                        pendingMedia = { type: 'audio/webm', data: reader.result };
                        sendMessage('рџЋ¤ Р“РѕР»РѕСЃРѕРІРѕРµ СЃРѕРѕР±С‰РµРЅРёРµ');
                    };
                    reader.readAsDataURL(audioBlob);
                    stream.getTracks().forEach(t => t.stop());
                };
                mediaRecorder.start();
                isRecording = true;
                document.getElementById('micBtn').classList.add('recording');
                // РѕРіСЂР°РЅРёС‡РёРј 30 СЃРµРєСѓРЅРґ
                setTimeout(() => { if (isRecording) stopRecording(); }, 30000);
            } catch (err) {
                alert('РќРµ СѓРґР°Р»РѕСЃСЊ РїРѕР»СѓС‡РёС‚СЊ РґРѕСЃС‚СѓРї Рє РјРёРєСЂРѕС„РѕРЅСѓ');
            }
        }
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('micBtn').classList.remove('recording');
            }
        }

        // ---------------------- Р РµРґР°РєС‚РёСЂРѕРІР°РЅРёРµ / СѓРґР°Р»РµРЅРёРµ СЃРѕРѕР±С‰РµРЅРёР№ ----------------------
        function deleteMessage(messageId, event) {
            event?.stopPropagation();
            if (!currentChat) return;
            const msg = messages[currentChat.id].find(m => m.id === messageId);
            if (!currentUser.isAdmin && msg.sender !== currentUser.id) { alert('РќРµР»СЊР·СЏ СѓРґР°Р»РёС‚СЊ С‡СѓР¶РѕРµ'); return; }
            if (!confirm('РЈРґР°Р»РёС‚СЊ?')) return;
            if (!deletedMessages[currentChat.id]) deletedMessages[currentChat.id] = [];
            if (!deletedMessages[currentChat.id].includes(messageId)) {
                deletedMessages[currentChat.id].push(messageId);
                localStorage.setItem('deletedMessages', JSON.stringify(deletedMessages));
            }
            messages[currentChat.id] = messages[currentChat.id].filter(m => m.id !== messageId);
            localStorage.setItem('messages', JSON.stringify(messages));
            if (ably) {
                const chatChannel = ably.channels.get(`chat-${currentChat.id}`);
                chatChannel.publish('delete', { messageId, senderId: currentUser.id, timestamp: Date.now() });
                if (currentUser.isAdmin) {
                    const adminChannel = ably.channels.get('admin-actions');
                    adminChannel.publish('delete-message', { chatId: currentChat.id, messageId });
                }
            }
            renderMessages(true);
        }

        function editMessage(messageId, event) {
            event?.stopPropagation();
            if (!currentChat) return;
            const msg = messages[currentChat.id].find(m => m.id === messageId);
            if (msg.sender !== currentUser.id) { alert('Р РµРґР°РєС‚РёСЂРѕРІР°С‚СЊ РјРѕР¶РЅРѕ С‚РѕР»СЊРєРѕ СЃРІРѕРё'); return; }
            messageToEdit = msg;
            document.getElementById('editMessageText').value = msg.text || '';
            document.getElementById('editMessageModal').classList.add('active');
        }
        function saveEditedMessage() {
            const newText = document.getElementById('editMessageText').value.trim();
            if (!newText || !messageToEdit || !currentChat) return;
            const idx = messages[currentChat.id].findIndex(m => m.id === messageToEdit.id);
            if (idx !== -1) {
                messages[currentChat.id][idx].text = newText;
                messages[currentChat.id][idx].edited = true;
                localStorage.setItem('messages', JSON.stringify(messages));
                if (ably) {
                    const chatChannel = ably.channels.get(`chat-${currentChat.id}`);
                    chatChannel.publish('edit', { messageId: messageToEdit.id, newText, timestamp: Date.now() });
                }
                renderMessages(true);
                closeEditMessageModal();
            }
        }

        // ---------------------- Р РµРЅРґРµСЂ СЃРѕРѕР±С‰РµРЅРёР№ ----------------------
        function renderMessages(animate = true) {
            const container = document.getElementById('messagesContainer');
            if (!container) return;
            container.innerHTML = '';
            if (!currentChat) { container.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:40px;">рџ‘€ Р’С‹Р±РµСЂРёС‚Рµ С‡Р°С‚</div>'; return; }
            if (!messages[currentChat.id] || messages[currentChat.id].length === 0) {
                container.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:40px;">РќРµС‚ СЃРѕРѕР±С‰РµРЅРёР№</div>';
                return;
            }
            messages[currentChat.id].sort((a,b) => (a.timestamp||0)-(b.timestamp||0));
            messages[currentChat.id].forEach(msg => {
                const div = document.createElement('div');
                div.className = `message ${msg.type}`;
                if (!animate) div.style.animation = 'none';
                div.setAttribute('data-id', msg.id);

                let content = '';
                if (msg.text) {
                    content = `<div class="message-bubble">${msg.text}${msg.edited ? ' <span style="font-size:10px;opacity:0.7;">(СЂРµРґ.)</span>' : ''}</div>`;
                } else if (msg.media) {
                    content = `<img src="${msg.media.url}" class="message-media" onclick="openMedia('${msg.media.url}')">`;
                } else if (msg.audio) {
                    content = `<audio controls src="${msg.audio.data}" style="max-width:250px;"></audio>`;
                }

                let actions = '';
                if (msg.sender === currentUser.id || currentUser.isAdmin) {
                    actions = `<div class="message-actions">
                        ${msg.sender === currentUser.id ? '<button class="message-action-btn" onclick="editMessage(\''+msg.id+'\', event)">вњЏпёЏ</button>' : ''}
                        <button class="message-action-btn" onclick="deleteMessage(\''+msg.id+'\', event)">рџ—‘пёЏ</button>
                    </div>`;
                }

                const showAdminBadge = msg.isAdmin && msg.senderName === ADMIN_USERNAME;
                div.innerHTML = `
                    ${actions}
                    ${msg.type === 'in' ? `<div class="message-sender">${msg.senderName}${showAdminBadge ? ' <span class="admin-badge">ADMIN</span>' : ''}</div>` : ''}
                    ${content}
                    <div class="message-time">${msg.time}</div>
                `;
                container.appendChild(div);
            });
            container.scrollTo({ top: container.scrollHeight, behavior: animate ? 'smooth' : 'auto' });
        }

        // ---------------------- РЎРїРёСЃРѕРє С‡Р°С‚РѕРІ ----------------------
        function updateChatsList() {
            const list = document.getElementById('chatsList');
            if (!list) return;
            list.innerHTML = '';
            let items = [];
            if (currentTab === 'chats') items = myChats;
            else if (currentTab === 'public') items = publicChats;
            else if (currentTab === 'users') items = Object.values(onlineUsers);

            const search = document.getElementById('searchInput').value.toLowerCase();
            if (search) items = items.filter(i => (i.name||'').toLowerCase().includes(search));

            if (items.length === 0) {
                list.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-secondary);">РќРёС‡РµРіРѕ РЅРµС‚</div>';
                return;
            }

            items.forEach(item => {
                const el = document.createElement('div');
                el.className = `chat-item ${currentChat?.id === item.id ? 'active' : ''}`;
                if (currentTab === 'users') {
                    el.onclick = () => createPrivateChat(item);
                    el.innerHTML = `
                        <div class="chat-avatar">${item.avatar?.startsWith('data:') ? `<img src="${item.avatar}">` : (item.avatar || 'рџ‘¤')}</div>
                        <div class="chat-details">
                            <div class="chat-name">${item.name} ${item.online ? '<span class="online-indicator"></span>' : ''}${item.isAdmin && item.name===ADMIN_USERNAME ? '<span class="admin-badge">ADMIN</span>' : ''}</div>
                            <div class="chat-last-message">${item.bio || ''}</div>
                        </div>
                    `;
                } else {
                    const lastMsg = messages[item.id]?.length ? messages[item.id][messages[item.id].length-1] : null;
                    const unread = unreadCounts[item.id] || 0;
                    el.onclick = () => joinChat(item);
                    let chatNameHTML = `${item.name || 'Р‘РµР· РЅР°Р·РІР°РЅРёСЏ'} ${item.password ? 'рџ”’' : ''}`;
                    if (currentUser?.isAdmin && currentUser.name === ADMIN_USERNAME && currentTab==='public') {
                        chatNameHTML += ` <button class="delete-chat-btn" onclick="deleteChat('${item.id}', event)">РЈРґР°Р»РёС‚СЊ</button>`;
                    }
                    el.innerHTML = `
                        <div class="chat-avatar">${(item.name||'?').charAt(0)}</div>
                        <div class="chat-details">
                            <div class="chat-name">${chatNameHTML}</div>
                            <div class="chat-last-message">${lastMsg ? (lastMsg.text || (lastMsg.media?'рџ“·':(lastMsg.audio?'рџЋ¤':''))) : (item.description||'')}</div>
                        </div>
                        <div class="chat-meta">
                            <div class="chat-time">${lastMsg ? lastMsg.time : ''}</div>
                            ${unread>0 ? `<div class="chat-unread">${unread}</div>` : ''}
                        </div>
                    `;
                }
                list.appendChild(el);
            });
        }

        function createPrivateChat(user) {
            const chatId = [currentUser.id, user.id].sort().join('-');
            let privateChat = myChats.find(c => c.id === chatId);
            if (!privateChat) {
                privateChat = { id: chatId, name: user.name, isPrivate: true, user: user, members: [currentUser.id, user.id] };
            }
            joinChat(privateChat);
        }

        // ---------------------- РџСЂРѕС„РёР»СЊ, СЃС‚Р°С‚СѓСЃ, Р°РІР°С‚Р°СЂ ----------------------
        function setStatus(status) {
            if (!currentUser) return;
            currentUser.status = status;
            document.querySelectorAll('.status-option').forEach(opt => opt.classList.remove('active'));
            document.querySelector(`.status-option[data-status="${status}"]`).classList.add('active');
            document.getElementById('profileStatusText').innerText = status==='online'?'РѕРЅР»Р°Р№РЅ':(status==='offline'?'РЅРµ РІ СЃРµС‚Рё':'РЅРµ Р±РµСЃРїРѕРєРѕРёС‚СЊ');
            // РѕР±РЅРѕРІРёС‚СЊ presence
            if (ably) {
                const presenceChannel = ably.channels.get('presence');
                if (status === 'offline') {
                    presenceChannel.presence.leave();
                } else {
                    presenceChannel.presence.update({ name: currentUser.name, avatar: currentUser.avatar, bio: currentUser.bio, isAdmin: currentUser.isAdmin, status: status });
                }
            }
        }

        function openAvatarModal() {
            const grid = document.getElementById('avatarGrid');
            grid.innerHTML = '';
            weirdEmojis.forEach(emoji => {
                const div = document.createElement('div');
                div.className = 'avatar-option';
                div.textContent = emoji;
                div.onclick = () => selectAvatar(emoji, div);
                if (currentUser.avatar === emoji) div.classList.add('selected');
                grid.appendChild(div);
            });
            document.getElementById('avatarModal').classList.add('active');
        }
        let selectedAvatar = null;
        function selectAvatar(emoji, element) {
            document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            selectedAvatar = emoji;
        }
        function uploadCustomAvatar() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    selectedAvatar = ev.target.result;
                    // РїРѕРєР°Р¶РµРј preview РІ СЃРµС‚РєРµ (РґРѕР±Р°РІРёРј РѕРїС†РёСЋ)
                    const grid = document.getElementById('avatarGrid');
                    Array.from(grid.children).forEach(opt => opt.classList.remove('selected'));
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'avatar-option selected';
                    imgDiv.innerHTML = `<img src="${selectedAvatar}" style="width:100%;height:100%;object-fit:cover;">`;
                    imgDiv.onclick = () => selectAvatar(selectedAvatar, imgDiv);
                    grid.prepend(imgDiv);
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }
        function saveAvatar() {
            if (selectedAvatar) {
                currentUser.avatar = selectedAvatar;
                const userKey = currentUser.name.toLowerCase();
                if (users[userKey]) users[userKey].avatar = selectedAvatar;
                localStorage.setItem('telegram_users', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                updateProfileUI();
                if (ably) {
                    const presenceChannel = ably.channels.get('presence');
                    presenceChannel.presence.update({ name: currentUser.name, avatar: selectedAvatar, bio: currentUser.bio, isAdmin: currentUser.isAdmin, status: currentUser.status });
                }
            }
            closeAvatarModal();
        }
        function closeAvatarModal() { document.getElementById('avatarModal').classList.remove('active'); selectedAvatar=null; }

        function openProfileModal() {
            document.getElementById('profileNameInput').value = currentUser.name;
            document.getElementById('profileEmailInput').value = currentUser.email || '';
            updateProfileUI(); // РѕР±РЅРѕРІРёС‚ СЃС‚Р°С‚СѓСЃ
            document.getElementById('profileModal').classList.add('active');
        }
        function closeProfileModal() { document.getElementById('profileModal').classList.remove('active'); }
        function saveProfile() {
            const newName = document.getElementById('profileNameInput').value.trim();
            if (newName && newName !== currentUser.name) {
                const oldKey = currentUser.name.toLowerCase();
                const newKey = newName.toLowerCase();
                if (users[newKey] && newKey !== oldKey) { alert('РРјСЏ Р·Р°РЅСЏС‚Рѕ'); return; }
                if (users[oldKey]) {
                    users[oldKey].name = newName;
                    if (newKey !== oldKey) { users[newKey] = users[oldKey]; delete users[oldKey]; }
                }
                currentUser.name = newName;
                localStorage.setItem('telegram_users', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                updateProfileUI();
                if (ably) {
                    const presenceChannel = ably.channels.get('presence');
                    presenceChannel.presence.update({ name: newName, avatar: currentUser.avatar, bio: currentUser.bio, isAdmin: currentUser.isAdmin, status: currentUser.status });
                }
            }
            closeProfileModal();
        }

        // ---------------------- РЈС‚РёР»РёС‚С‹ ----------------------
        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tabChats').className = tab==='chats'?'tab active':'tab';
            document.getElementById('tabPublic').className = tab==='public'?'tab active':'tab';
            document.getElementById('tabUsers').className = tab==='users'?'tab active':'tab';
            document.getElementById('searchInput').value = '';
            updateChatsList();
        }
        function handleSearch() { updateChatsList(); }
        function togglePassword(id) {
            const inp = document.getElementById(id);
            inp.type = inp.type === 'password' ? 'text' : 'password';
        }
        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            if (picker.style.display === 'none') {
                picker.style.display = 'flex';
                if (picker.children.length === 0) {
                    emojiList.slice(0,100).forEach(emoji => {
                        const btn = document.createElement('button');
                        btn.className = 'emoji-btn';
                        btn.textContent = emoji;
                        btn.onclick = () => addEmoji(emoji);
                        picker.appendChild(btn);
                    });
                }
            } else picker.style.display = 'none';
        }
        function addEmoji(emoji) {
            const input = document.getElementById('messageInput');
            const start = input.selectionStart;
            input.value = input.value.substring(0,start) + emoji + input.value.substring(input.selectionEnd);
            input.focus();
            input.selectionStart = input.selectionEnd = start + emoji.length;
            input.style.height = 'auto'; input.style.height = input.scrollHeight + 'px';
        }
        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
        function openCreateChatModal() { document.getElementById('createChatModal').classList.add('active'); }
        function closeCreateChatModal() { document.getElementById('createChatModal').classList.remove('active'); document.getElementById('chatNameInput').value=''; document.getElementById('chatPasswordInput').value=''; document.getElementById('chatDescriptionInput').value=''; }
        function closeJoinChatModal() { document.getElementById('joinChatModal').classList.remove('active'); document.getElementById('joinPasswordInput').value=''; pendingChatToJoin=null; }
        function closeEditMessageModal() { document.getElementById('editMessageModal').classList.remove('active'); document.getElementById('editMessageText').value=''; messageToEdit=null; }
        function openMedia(url) {
            const viewer = document.getElementById('mediaViewer');
            const content = document.getElementById('mediaViewerContent');
            content.innerHTML = url.match(/\.(mp4|webm|ogg)$/i) ? `<video src="${url}" controls autoplay></video>` : `<img src="${url}">`;
            viewer.classList.add('active');
        }
        function closeMediaViewer() { document.getElementById('mediaViewer').classList.remove('active'); document.getElementById('mediaViewerContent').innerHTML=''; }
        function updateUrlWithChat(chat) {
            const url = chat ? `${window.location.pathname}#${chat.id}` : window.location.pathname;
            window.history.pushState({}, '', url);
        }
        function checkUrlForChat() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                const chat = myChats.find(c => c.id===hash) || publicChats.find(c => c.id===hash);
                if (chat) setTimeout(() => joinChat(chat),500);
            }
        }

        // РЎС‚Р°СЂС‚
        checkSavedSession();

        // РђРІС‚Рѕ-СЃРєСЂС‹С‚РёРµ СѓРІРµРґРѕРјР»РµРЅРёР№
        window.addEventListener('load', () => {
            document.getElementById('messageInput').addEventListener('input', function() {
                this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px';
            });
        });
    </script>
</body>
</html>
